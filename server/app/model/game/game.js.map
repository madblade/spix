{"version":3,"sources":["../../../../../server/app/model/game/game.js"],"names":[],"mappings":"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","file":"game.js","sourcesContent":["/**\n * Game (instance) model.\n */\n\n'use strict';\n\nimport Factory from '../factory';\n\nclass Game {\n\n    constructor(hub, gameId, connector) {\n        // Utility parameters.\n        this._hub = hub;\n        this._gameId = gameId;\n        this._jobId = null;\n        this._timeIdleId = null;\n        this._connection = connector;\n\n        //\n        this._kind = null;\n        this._refreshRate = 200;\n        this._isRunning = false;\n        this._ready = false;\n\n        //\n        this._playerManager = Factory.createPlayerManager();\n    }\n\n    // Model\n    get players()       { return this._playerManager; }\n    get connector()     { return this._connection; }\n\n    get ready()         { return this._ready; }\n    get kind()          { return this._kind; }\n    get gameId()        { return this._gameId; }\n    get isRunning()     { return this._isRunning; }\n\n    set ready(value)    { this._ready = value; }\n\n    /** Connection **/\n\n    // Send a message to ALL connected users.\n    // N.B. encouraged to create custom subchannels within implementations.\n    broadcast(kind, data) {\n        // TODO [LOW] optimize with dynamic subchans\n        this._connection.io.to(this._gameId).emit(kind, data);\n    }\n\n    /** Game loop **/\n\n    // Server-render update function (abstract).\n    update() {\n        console.log(\"Abstract loop.\");\n    }\n\n    // Start game loop.\n    start() {\n        // Stop waiting for idle threshold.\n        clearTimeout(this._timeIdleId);\n\n        // Launch\n        this._isRunning = true;\n        console.log(\"Game running.\");\n        this._jobId = setInterval(_ => {\n            this.update();\n        }, this._refreshRate);\n    }\n\n    // Stop game loop.\n    pause(doTimeout) {\n        console.log(\"Game stopping.\");\n        if (this._jobId !== undefined) clearInterval(this._jobId);\n        this._isRunning = false;\n\n        // Set idle time limit before despawning this game.\n        if (doTimeout) this._timeIdleId = setTimeout(_ => this.stop(), 30000);\n    }\n\n    /** Players **/\n\n    addPlayer(player) {\n        console.log('A player joined.');\n\n        // Join channel.\n        player.join(this.gameId);\n\n        // Add player to model.\n        this._playerManager.addPlayer(player);\n\n        // Start game if need be.\n        if (this._isRunning) return;\n        this._isRunning = true; // Double check\n        this.start();\n    }\n\n    removePlayer(player) {\n        console.log('A player left.');\n\n        // Remove from model.\n        this._playerManager.removePlayer(player);\n\n        // Stop game if need be.\n        if (this._playerManager.nbPlayers > 0 || !this._isRunning) return;\n        this.pause(true); // Stop with idle timeout.\n    }\n\n    removeAllPlayers() {\n        this._playerManager.removeAllPlayers();\n        if (this._isRunning) this.pause(true); // Stop with idle timeout.\n    }\n\n    // Auto-destruction for being idle for too long. Internal use.\n    stop() {\n        console.log(\"Game \" + this._gameId + \" ended for being idle for too long.\");\n        this._hub.endGame(this);\n    }\n\n    // To be triggered from Hub only.\n    destroy() {\n        if (this._isRunning) this.pause(false); // Going to destroy -> no idle timeout.\n        this.removeAllPlayers();\n        this._playerManager.destroy();\n        delete this._hub;\n        delete this._timeIdleId;\n        delete this._gameId;\n        delete this._jobId;\n        delete this._connection;\n        delete this._kind;\n        delete this._refreshRate;\n        delete this._isRunning;\n    }\n\n}\n\nexport default Game;\n"]}