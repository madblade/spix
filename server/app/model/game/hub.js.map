{"version":3,"sources":["../../../../../server/app/model/game/hub.js"],"names":[],"mappings":"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","file":"hub.js","sourcesContent":["/**\n * Game management.\n */\n\n'use strict';\n\nimport CollectionUtils from '../../engine/math/collections';\nimport Factory from '../factory';\n\nclass Hub {\n\n    constructor(app) {\n        this._app = app;\n        this._games = new Map();\n    }\n\n    static validateUser(user) {\n        // Do validation\n        var res = user !== null;\n        if (!res) console.log('Invalid user requested new game.');\n        return res;\n    }\n\n    static validateKind(kind) {\n        var res = false;\n        switch (kind) {\n            case 'game3d': case 'game2d':\n                res = true;\n        }\n        if (!res) console.log('Invalid game kind requested.');\n        return res;\n    }\n\n    validateRequest() {\n        // Count games.\n        let games = this._games;\n\n        let nbGames = 0;\n        games.forEach((gamesForKind, kind) => {\n            nbGames += gamesForKind.size;\n        });\n\n        const validation = nbGames < 5;\n        console.log(nbGames>0?nbGames:'No' + ' game' + (nbGames>1?'s are':' is') + ' running or idle.');\n        if (!validation) console.log('Invalid game creation request.');\n        return validation;\n    }\n\n    requestNewGame(user, kind) {\n        let app = this._app;\n\n        // Verify.\n        if (!Hub.validateUser(user)) return false;\n        if (!Hub.validateKind(kind)) return false;\n        if (!this.validateRequest()) return false;\n\n        // Create game and notify users.\n        const id = this.addGame(kind);\n        app.connection.db.notifyGameCreation(kind, id);\n\n        return true;\n    }\n\n    getGame(kind, gameId) {\n        let gamesOfKind = this._games.get(kind);\n        if (!gamesOfKind) return;\n        return gamesOfKind.get(gameId);\n    }\n\n    /**\n     * Lists all games with minimal information.\n     * @returns {{}} Object: 1 id = 1 game kind; 1 element = 1 array of game ids.\n     */\n    listGames() {\n        let games = {};\n        let modelGames = this._games;\n\n        modelGames.forEach((gamesForKind, kind) => {\n            games[kind] = [];\n            let g = games[kind];\n            gamesForKind.forEach((game, gameId) => {\n                g.push(gameId);\n            });\n        });\n\n        return games;\n    }\n\n    /**\n     * Not param-safe: use 'requestNewGame' to ensure kind validity.\n     * @param kind\n     * @returns {*}\n     */\n    addGame(kind) {\n        let games = this._games;\n        let connection = this._app.connection;\n\n        // Init list of games of this kind\n        if (!games.has(kind)) games.set(kind, new Map());\n        let gid = CollectionUtils.generateId(games.get(kind));\n\n        // Create matching game\n        var game = Factory.createGame(this, kind, gid, connection);\n\n        // Add to games.\n        if (game) games.get(kind).set(gid, game);\n\n        return game.gameId;\n    }\n\n    endGame(game) {\n        if (game.isRunning) {\n            console.log(\"WARN! Trying to end a running game. Abort.\");\n            return;\n        }\n\n        let games = this._games;\n        let gid = game.gameId;\n        let kind = game.kind;\n\n        game.destroy();\n        let gamesOfKind = games.get(kind);\n        gamesOfKind.delete(gid);\n        if (gamesOfKind.size < 1) games.delete(kind);\n    }\n\n}\n\nexport default Hub;\n"]}