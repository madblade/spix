"use strict";function extend(a,b){if("object"!==("undefined"==typeof a?"undefined":_typeof(a))||"object"!==("undefined"==typeof b?"undefined":_typeof(b)))throw Error("Could not extend "+a+" with "+b);for(var c in b){if(a.hasOwnProperty(c))throw Error("Tried to override existing property "+c);if(b.hasOwnProperty(c)){var d=b[c];if("function"!=typeof d)throw Error("Could not extend prototype with "+d);a[c]=b[c]}}}function extend(a,b){if("object"!=typeof a||"object"!=typeof b)throw Error("Could not extend "+a+" with "+b);for(var c in b){if(a.hasOwnProperty(c))throw Error("Tried to override existing property "+c);if(b.hasOwnProperty(c)){var d=b[c];if("function"!=typeof d)throw Error("Could not extend prototype with "+d);a[c]=b[c]}}}var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(a){return typeof a}:function(a){return a&&"function"==typeof Symbol&&a.constructor===Symbol?"symbol":typeof a},App=App||{State:{},Core:{},Engine:{},Model:{},Modules:{}};App.Core=function(){this.state=new App.State.StateManager(this),this.engine={connection:new App.Engine.Connection(this),graphics:new App.Engine.Graphics(this),audio:new App.Engine.Audio(this),controls:new App.Engine.UI(this),settings:new App.Engine.Settings(this)},this.model={hub:new App.Model.Hub(this),server:new App.Model.Server(this),client:new App.Model.Client(this)},this.register=new App.Modules.Register(this),this.register.registerDefaultModules()},extend(App.Core.prototype,{start:function(){this.setState("loading"),this.engine.connection.connect()},stop:function(){this.setState("loading"),this.engine.connection.disconnect(),this.stopGame()}});var App=App||{State:{},Core:{},Engine:{},Model:{},Modules:{}};App.Core=function(){this.state=new App.State.StateManager(this),this.engine={connection:new App.Engine.Connection(this),graphics:new App.Engine.Graphics(this),audio:new App.Engine.Audio(this),controls:new App.Engine.UI(this),settings:new App.Engine.Settings(this)},this.model={hub:new App.Model.Hub(this),server:new App.Model.Server(this),client:new App.Model.Client(this)},this.register=new App.Modules.Register(this),this.register.registerDefaultModules()},extend(App.Core.prototype,{start:function(){this.setState("loading"),this.engine.connection.connect()},stop:function(){this.setState("loading"),this.engine.connection.disconnect(),this.stopGame()}}),extend(App.Core.prototype,{getState:function(){return this.state.state},setState:function(a,b){this.state.setState(a,b)},isLoading:function(){return"loading"===this.getState()},isFocused:function(){return this.state.focus},setFocused:function(a){this.state.focus=!!a},connectionEstablished:function(){console.log("Connected."),setTimeout(function(){this.engine.connection.requestHubState()}.bind(this),1500)},requestGameCreation:function(a){if("hub"!==this.getState())throw"Could not request game creation outside of Hub.";this.engine.connection.requestGameCreation(a)},join:function(a,b){if("hub"!==this.getState())throw"Could not request game joining outside of Hub.";console.log("Join request..."),this.setState("ingame"),this.engine.connection.configureGame(a,b),this.model.client.init(a),this.model.server.init(a),console.log("Game effectively started."),this.engine.connection.join(a,b)},joinedServer:function(){console.log("Joined server."),this.runGame()},runGame:function(){this.engine.graphics.run(),this.engine.controls.run(),this.engine.audio.run()},stopGame:function(){this.engine.graphics.stop(),this.engine.controls.stop(),this.engine.audio.stop()}}),extend(App.Core.prototype,{getState:function(){return this.state.state},setState:function(a,b){this.state.setState(a,b)},isLoading:function(){return"loading"===this.getState()},isFocused:function(){return this.state.focus},setFocused:function(a){this.state.focus=!!a},connectionEstablished:function(){console.log("Connected."),setTimeout(function(){this.engine.connection.requestHubState()}.bind(this),1500)},requestGameCreation:function(a){if("hub"!==this.getState())throw"Could not request game creation outside of Hub.";this.engine.connection.requestGameCreation(a)},join:function(a,b){if("hub"!==this.getState())throw"Could not request game joining outside of Hub.";console.log("Join request..."),this.setState("ingame"),this.engine.connection.configureGame(a,b),this.model.client.init(a),this.model.server.init(a),console.log("Game effectively started."),this.engine.connection.join(a,b)},joinedServer:function(){console.log("Joined server."),this.runGame()},runGame:function(){this.engine.graphics.run(),this.engine.controls.run(),this.engine.audio.run()},stopGame:function(){this.engine.graphics.stop(),this.engine.controls.stop(),this.engine.audio.stop()}}),extend(App.Core.prototype,{registerModule:function(a){},restartModule:function(a){}}),extend(App.Core.prototype,{registerModule:function(a){},restartModule:function(a){}}),App.Engine.Audio=function(a){this.app=a,this.settings={},this.audioContext=null,this.source=null,this.sounds={all:[]}},extend(App.Engine.Audio.prototype,{run:function(){function a(a,b){var c=new XMLHttpRequest;c.open("GET","audio/"+a+".mp3",!0),c.responseType="arraybuffer",c.onreadystatechange=function(){4==c.readyState&&"200"==c.status&&audioContext.decodeAudioData(c.response,function(a){b(a)})},c.send(null)}try{window.AudioContext=window.AudioContext||window.webkitAudioContext,this.audioContext=new AudioContext;var b=this.sounds;b.all.forEach(function(c){a(c,function(a){b[c]=new App.Engine.Audio.Sound(c,a)})})}catch(c){}},stop:function(){this.stopAllSounds()},stopAllSounds:function(){var a=this.sounds;a.all.forEach(function(b){null!==a[b].source&&a[b].playing&&(a[b].source.stop(),a[b].playing=!1)})}}),App.Engine.Audio=function(a){this.app=a,this.settings={},this.audioContext=null,this.source=null,this.sounds={all:[]}},extend(App.Engine.Audio.prototype,{run:function(){function a(a,b){var c=new XMLHttpRequest;c.open("GET","audio/"+a+".mp3",!0),c.responseType="arraybuffer",c.onreadystatechange=function(){4==c.readyState&&"200"==c.status&&audioContext.decodeAudioData(c.response,function(a){b(a)})},c.send(null)}try{window.AudioContext=window.AudioContext||window.webkitAudioContext,this.audioContext=new AudioContext;var b=this.sounds;b.all.forEach(function(c){a(c,function(a){b[c]=new App.Engine.Audio.Sound(c,a)})})}catch(c){}},stop:function(){this.stopAllSounds()},stopAllSounds:function(){var a=this.sounds;a.all.forEach(function(b){null!==a[b].source&&a[b].playing&&(a[b].source.stop(),a[b].playing=!1)})}}),App.Engine.Audio.Sound=function(a,b){this.name=a,this.buffer=b,this.playing=!1,this.play=function(){this.stopAllSounds(),this.source=this.audioContext.createBufferSource(),this.source.buffer=b,this.source.connect(this.audioContext.destination),this.playing=!0,this.source.start()}.bind(this)},App.Engine.Audio.Sound=function(a,b){this.name=a,this.buffer=b,this.playing=!1,this.play=function(){this.stopAllSounds(),this.source=this.audioContext.createBufferSource(),this.source.buffer=b,this.source.connect(this.audioContext.destination),this.playing=!0,this.source.start()}.bind(this)},App.Engine.Connection=function(a){this.app=a,this.socket={}},extend(App.Engine.Connection.prototype,{connect:function(a){var b="",c=this.app,d=c.model.hub;a||"localhost"===location.hostname||(b="ws://"+location.hostname+":8000"),this.socket=io(b,{path:"/socket.io-client"}),this.socket.on("hub",function(a){d.update(a)}),this.socket.on("joined",function(){c.joinedServer()}),this.socket.on("cantjoin",function(){location.reload()}),this.socket.on("connected",function(){c.connectionEstablished()}),this.socket.on("connect",function(){console.log("Connecting...")}),this.socket.on("disconnect",function(){console.log("Disconected! :(")}),this.socket.on("reconnect",function(){console.log("Reconnecting...")}),this.socket.on("reconnect_failed",function(){console.log("Could not reconnect after MANY attempts.")}),this.socket.on("reconnect_error",function(){console.log("Reconnection failed! :(")})},disconnect:function(){var a=this;a.unregisterSocketForGame3D(),["hub","joined","cantjoin","connected","connect","disconnect","reconnect","reconnect_failed","reconnect_error"].forEach(function(a){this.removeCustomListener(a)}.bind(this))},addCustomListener:function(a,b){this.socket.on(a,b)},removeCustomListener:function(a){this.socket.removeAllListeners(a)},send:function(a,b){this.socket.emit(a,b)},join:function(a,b){this.send("util",{request:"joinGame",gameType:a,gameId:b})},requestHubState:function(){this.send("util",{request:"hub"})},requestGameCreation:function(a){this.send("util",{request:"createGame",gameType:a})},configureGame:function(a,b){switch(a){case"game3d":this.registerSocketForGame3D();break;default:throw"Could not configure socket listeners for an unknown game type."}}}),App.Engine.Connection=function(a){this.app=a,this.socket={}},extend(App.Engine.Connection.prototype,{connect:function(a){var b="",c=this.app,d=c.model.hub;a||"localhost"===location.hostname||(b="ws://"+location.hostname+":8000"),this.socket=io(b,{path:"/socket.io-client"}),this.socket.on("hub",function(a){d.update(a)}),this.socket.on("joined",function(){c.joinedServer()}),this.socket.on("cantjoin",function(){location.reload()}),this.socket.on("connected",function(){c.connectionEstablished()}),this.socket.on("connect",function(){console.log("Connecting...")}),this.socket.on("disconnect",function(){console.log("Disconected! :(")}),this.socket.on("reconnect",function(){console.log("Reconnecting...")}),this.socket.on("reconnect_failed",function(){console.log("Could not reconnect after MANY attempts.")}),this.socket.on("reconnect_error",function(){console.log("Reconnection failed! :(")})},disconnect:function(){var a=this;a.unregisterSocketForGame3D(),["hub","joined","cantjoin","connected","connect","disconnect","reconnect","reconnect_failed","reconnect_error"].forEach(function(a){this.removeCustomListener(a)}.bind(this))},addCustomListener:function(a,b){this.socket.on(a,b)},removeCustomListener:function(a){this.socket.removeAllListeners(a)},send:function(a,b){this.socket.emit(a,b)},join:function(a,b){this.send("util",{request:"joinGame",gameType:a,gameId:b})},requestHubState:function(){this.send("util",{request:"hub"})},requestGameCreation:function(a){this.send("util",{request:"createGame",gameType:a})},configureGame:function(a,b){switch(a){case"game3d":this.registerSocketForGame3D();break;default:throw"Could not configure socket listeners for an unknown game type."}}}),extend(App.Engine.Connection.prototype,{registerSocketForGame3D:function(){var a=this.app.model.server,b=this.app.register;this.addCustomListener("chk",a.updateChunks.bind(a)),this.addCustomListener("ent",a.updateEntities.bind(a)),this.addCustomListener("x",a.updateX.bind(a)),this.addCustomListener("chat",b.updateChat.bind(b))},unregisterSocketForGame3D:function(){this.removeCustomListener("chk"),this.removeCustomListener("ent"),this.removeCustomListener("x"),this.removeCustomListener("chat")}}),extend(App.Engine.Connection.prototype,{registerSocketForGame3D:function(){var a=this.app.model.server,b=this.app.register;this.addCustomListener("chk",a.updateChunks.bind(a)),this.addCustomListener("ent",a.updateEntities.bind(a)),this.addCustomListener("x",a.updateX.bind(a)),this.addCustomListener("chat",b.updateChat.bind(b))},unregisterSocketForGame3D:function(){this.removeCustomListener("chk"),this.removeCustomListener("ent"),this.removeCustomListener("x"),this.removeCustomListener("chat")}}),App.Engine.UI=function(a){this.app=a,this.settings={language:""},this.threeControlsEnabled=!1,this.keyControls={},this.mouse={},this.touch={}},extend(App.Engine.UI.prototype,{run:function(){var a=this.app.engine.graphics;this.setupKeyboard(),this.setupMouse(),this.setupTouch(),$(window).resize(a.resize.bind(a))},stop:function(){this.stopListeners()},stopListeners:function(){this.stopKeyboardListeners(),this.stopMouseListeners(),this.stopTouchListeners()}}),App.Engine.UI=function(a){this.app=a,this.settings={language:""},this.threeControlsEnabled=!1,this.keyControls={},this.mouse={},this.touch={}},extend(App.Engine.UI.prototype,{run:function(){var a=this.app.engine.graphics;this.setupKeyboard(),this.setupMouse(),this.setupTouch(),$(window).resize(a.resize.bind(a))},stop:function(){this.stopListeners()},stopListeners:function(){this.stopKeyboardListeners(),this.stopMouseListeners(),this.stopTouchListeners()}}),extend(App.Engine.UI.prototype,{setupKeyboard:function(){this.settings.language=window.navigator.userLanguage||window.navigator.language||"en-US",this.settings.language="fr",this.keyControls=this.getKeyControls(this.settings.language),this.tweak=0},startKeyboardListeners:function(){this.registerKeyDown(),this.registerKeyUp()},stopKeyboardListeners:function(){this.stopKeyboardInteraction(),this.unregisterKeyDown(),this.unregisterKeyUp()},changeLayout:function(a,b,c){switch(this.stopKeyboardListeners(),a){case"fr":case"en":case"en-US":case"en-GB":this.keyControls=this.getKeyControls(a);break;case"custom":default:this.setupCustomLayout(c)}b||this.startKeyboardListeners()}}),extend(App.Engine.UI.prototype,{setupKeyboard:function(){this.settings.language=window.navigator.userLanguage||window.navigator.language||"en-US",this.settings.language="fr",this.keyControls=this.getKeyControls(this.settings.language),this.tweak=0},startKeyboardListeners:function(){this.registerKeyDown(),this.registerKeyUp()},stopKeyboardListeners:function(){this.stopKeyboardInteraction(),this.unregisterKeyDown(),this.unregisterKeyUp()},changeLayout:function(a,b,c){switch(this.stopKeyboardListeners(),a){case"fr":case"en":case"en-US":case"en-GB":this.keyControls=this.getKeyControls(a);break;case"custom":default:this.setupCustomLayout(c)}b||this.startKeyboardListeners()}}),extend(App.Engine.UI.prototype,{getAZERTY:function(a){return{arrowUp:38,arrowDown:40,arrowRight:39,arrowLeft:37,leftHandUp:90,leftHandLeft:81,leftHandDown:83,leftHandRight:68,leftHandNorthWest:65,leftHandNorthEast:69,leftHandNorthEast2:82,leftHandEast2:70,leftHandSouthWest:87,leftHandSouth:88,leftHandSouthEast:67,alt:18,shift:16,control:17,tab:9,escape:27,space:32,backspace:8,enter:13,pageUp:33,pageDown:34,one:49,two:50,three:51,four:52,five:53,six:54,seven:55,eight:56,nine:57,padOne:97,padTwo:98,padThree:99,padFour:100,padFive:101,padSix:102,padSeven:103,padEight:104,padNine:105,padOneAlt:35,padTwoAlt:40,padThreeAlt:34,padFourAlt:37,padFiveAlt:12,padSixAlt:39,padSevenAlt:36,padEightAlt:38,padNineAlt:33,leftHandNorthEast3:84,leftHandEast3:71,leftHandSouthEast3:86,rightHandUp:73,rightHandDown:75,rightHandLeft:74,rightHandLeft2:72,rightHandRight:76,rightHandRight2:77,rightHandSouth:190,rightHandNorthWest:85,rightHandNorthWest2:89,rightHandNorthEast:79,rightHandNorthEast2:80,rightHandSouthWest:188,rightHandSouthWest2:78,rightHandSouthWest3:66,rightHandSouthEast:191,rightHandSouthEast2:223}}}),extend(App.Engine.UI.prototype,{getAZERTY:function(a){return{arrowUp:38,arrowDown:40,arrowRight:39,arrowLeft:37,leftHandUp:90,leftHandLeft:81,leftHandDown:83,leftHandRight:68,leftHandNorthWest:65,leftHandNorthEast:69,leftHandNorthEast2:82,leftHandEast2:70,leftHandSouthWest:87,leftHandSouth:88,leftHandSouthEast:67,alt:18,shift:16,control:17,tab:9,escape:27,space:32,backspace:8,enter:13,pageUp:33,pageDown:34,one:49,two:50,three:51,four:52,five:53,six:54,seven:55,eight:56,nine:57,padOne:97,padTwo:98,padThree:99,padFour:100,padFive:101,padSix:102,padSeven:103,padEight:104,padNine:105,padOneAlt:35,padTwoAlt:40,padThreeAlt:34,padFourAlt:37,padFiveAlt:12,padSixAlt:39,padSevenAlt:36,padEightAlt:38,padNineAlt:33,leftHandNorthEast3:84,leftHandEast3:71,leftHandSouthEast3:86,rightHandUp:73,rightHandDown:75,rightHandLeft:74,rightHandLeft2:72,rightHandRight:76,rightHandRight2:77,rightHandSouth:190,rightHandNorthWest:85,rightHandNorthWest2:89,rightHandNorthEast:79,rightHandNorthEast2:80,rightHandSouthWest:188,rightHandSouthWest2:78,rightHandSouthWest3:66,rightHandSouthEast:191,rightHandSouthEast2:223}}}),extend(App.Engine.UI.prototype,{setupCustomLayout:function(a){if(!a||2!==a.length)return void console.log("Binding "+a+" not supported.");var b=this.keyControls,c=a[0],d=a[1];if(b.hasOwnProperty(c)){for(var e in b)if(e!==c&&b[e]===d)return b[e]=b[c],void(b[c]=d);b[c]=d}else console.log("Binding "+a+" not supported.")}}),extend(App.Engine.UI.prototype,{setupCustomLayout:function(a){if(!a||2!==a.length)return void console.log("Binding "+a+" not supported.");var b=this.keyControls,c=a[0],d=a[1];if(b.hasOwnProperty(c)){for(var e in b)if(e!==c&&b[e]===d)return b[e]=b[c],void(b[c]=d);b[c]=d}else console.log("Binding "+a+" not supported.")}}),extend(App.Engine.UI.prototype,{getKeyControls:function(a){var b;switch(a){case"en":case"en-US":case"en-GB":b=this.getQWERTY();break;case"fr":b=this.getAZERTY();break;default:return console.log("Invalid keyboard layout. Switching to English as default."),void(b=this.getQWERTY())}return b}}),extend(App.Engine.UI.prototype,{getKeyControls:function(a){var b;switch(a){case"en":case"en-US":case"en-GB":b=this.getQWERTY();break;case"fr":b=this.getAZERTY();break;default:return console.log("Invalid keyboard layout. Switching to English as default."),void(b=this.getQWERTY())}return b}}),extend(App.Engine.UI.prototype,{registerKeyDown:function(){var a=this.app;$(window).keydown(function(b){if(b.preventDefault(),b.keyCode&&"ingame"===a.getState()){var c=this.keyControls,d=a.model.client;a.engine.graphics;switch(b.keyCode){case c.arrowUp:case c.leftHandUp:d.triggerEvent("m","f");break;case c.arrowRight:case c.leftHandRight:d.triggerEvent("m","r");break;case c.arrowLeft:case c.leftHandLeft:d.triggerEvent("m","l");break;case c.arrowDown:case c.leftHandDown:d.triggerEvent("m","b");break;case c.shift:d.triggerEvent("m","d");break;case c.space:d.triggerEvent("m","u");break;case c.leftHandEast2:d.triggerChange("camera","toggle");break;case c.leftHandNorthEast2:d.triggerChange("interaction","toggle");break;case c.leftHandEast3:d.triggerEvent("a","g");break;case c.enter:}}}.bind(this))},stopKeyboardInteraction:function(){var a=this.app.model.client;a.triggerEvent("m","xx")},registerKeyUp:function(){var a=this.app;$(window).keyup(function(b){if(b.preventDefault(),b.keyCode&&"ingame"===a.getState()){var c=this.keyControls,d=a.model.client;switch(b.keyCode){case c.arrowUp:case c.leftHandUp:d.triggerEvent("m","fx");break;case c.arrowRight:case c.leftHandRight:d.triggerEvent("m","rx");break;case c.arrowLeft:case c.leftHandLeft:d.triggerEvent("m","lx");break;case c.arrowDown:case c.leftHandDown:d.triggerEvent("m","bx");break;case c.shift:d.triggerEvent("m","dx");break;case c.space:d.triggerEvent("m","ux")}}}.bind(this))},unregisterKeyDown:function(){$(window).off("keydown")},unregisterKeyUp:function(){$(window).off("keyup")}}),extend(App.Engine.UI.prototype,{registerKeyDown:function(){var a=this.app;$(window).keydown(function(b){if(b.preventDefault(),b.keyCode&&"ingame"===a.getState()){var c=this.keyControls,d=a.model.client;a.engine.graphics;switch(b.keyCode){case c.arrowUp:case c.leftHandUp:d.triggerEvent("m","f");break;case c.arrowRight:case c.leftHandRight:d.triggerEvent("m","r");break;case c.arrowLeft:case c.leftHandLeft:d.triggerEvent("m","l");break;case c.arrowDown:case c.leftHandDown:d.triggerEvent("m","b");break;case c.shift:d.triggerEvent("m","d");break;case c.space:d.triggerEvent("m","u");break;case c.leftHandEast2:d.triggerChange("camera","toggle");break;case c.leftHandNorthEast2:d.triggerChange("interaction","toggle");break;case c.leftHandEast3:d.triggerEvent("a","g");break;case c.enter:}}}.bind(this))},stopKeyboardInteraction:function(){var a=this.app.model.client;a.triggerEvent("m","xx")},registerKeyUp:function(){var a=this.app;$(window).keyup(function(b){if(b.preventDefault(),b.keyCode&&"ingame"===a.getState()){var c=this.keyControls,d=a.model.client;switch(b.keyCode){case c.arrowUp:case c.leftHandUp:d.triggerEvent("m","fx");break;case c.arrowRight:case c.leftHandRight:d.triggerEvent("m","rx");break;case c.arrowLeft:case c.leftHandLeft:d.triggerEvent("m","lx");break;case c.arrowDown:case c.leftHandDown:d.triggerEvent("m","bx");break;case c.shift:d.triggerEvent("m","dx");break;case c.space:d.triggerEvent("m","ux")}}}.bind(this))},unregisterKeyDown:function(){$(window).off("keydown")},unregisterKeyUp:function(){$(window).off("keyup")}}),extend(App.Engine.UI.prototype,{getQWERTY:function(){return{arrowUp:38,arrowDown:40,arrowRight:39,arrowLeft:37,leftHandUp:87,leftHandLeft:65,leftHandDown:83,leftHandRight:68,leftHandNorthWest:81,leftHandNorthEast:69,leftHandNorthEast2:82,leftHandEast2:70,leftHandSouthWest:90,leftHandSouth:88,leftHandSouthEast:67,alt:18,shift:16,control:17,tab:9,escape:27,space:32,backspace:8,enter:13,pageUp:33,pageDown:34,one:49,two:50,three:51,four:52,five:53,six:54,seven:55,eight:56,nine:57,padOne:97,padTwo:98,padThree:99,padFour:100,padFive:101,padSix:102,padSeven:103,padEight:104,padNine:105,padOneAlt:35,padTwoAlt:40,padThreeAlt:34,padFourAlt:37,padFiveAlt:12,padSixAlt:39,padSevenAlt:36,padEightAlt:38,padNineAlt:33,leftHandNorthEast3:84,leftHandEast3:71,leftHandSouthEast3:86,rightHandUp:73,rightHandDown:75,rightHandLeft:74,rightHandLeft2:72,rightHandRight:76,rightHandRight2:186,rightHandSouth:188,rightHandNorthWest:85,rightHandNorthWest2:89,rightHandNorthEast:79,rightHandNorthEast2:80,rightHandSouthWest:77,rightHandSouthWest2:78,rightHandSouthWest3:66,rightHandSouthEast:190,rightHandSouthEast2:191}}}),extend(App.Engine.UI.prototype,{getQWERTY:function(){return{arrowUp:38,arrowDown:40,arrowRight:39,arrowLeft:37,leftHandUp:87,leftHandLeft:65,leftHandDown:83,leftHandRight:68,leftHandNorthWest:81,leftHandNorthEast:69,leftHandNorthEast2:82,leftHandEast2:70,leftHandSouthWest:90,leftHandSouth:88,leftHandSouthEast:67,alt:18,shift:16,control:17,tab:9,escape:27,space:32,backspace:8,enter:13,pageUp:33,pageDown:34,one:49,two:50,three:51,four:52,five:53,six:54,seven:55,eight:56,nine:57,padOne:97,padTwo:98,padThree:99,padFour:100,padFive:101,padSix:102,padSeven:103,padEight:104,padNine:105,padOneAlt:35,padTwoAlt:40,padThreeAlt:34,padFourAlt:37,padFiveAlt:12,padSixAlt:39,padSevenAlt:36,padEightAlt:38,padNineAlt:33,leftHandNorthEast3:84,leftHandEast3:71,leftHandSouthEast3:86,rightHandUp:73,rightHandDown:75,rightHandLeft:74,rightHandLeft2:72,rightHandRight:76,rightHandRight2:186,rightHandSouth:188,rightHandNorthWest:85,rightHandNorthWest2:89,rightHandNorthEast:79,rightHandNorthEast2:80,rightHandSouthWest:77,rightHandSouthWest2:78,rightHandSouthWest3:66,rightHandSouthEast:190,rightHandSouthEast2:191}}}),extend(App.Engine.UI.prototype,{setupMouse:function(){this.buttons={left:1,middle:2,right:3},this.setupPointerLock()},getControls:function(a){var b;return"first-person"===a?(b=this.getFirstPersonControls(),b.type="fp"):b=void 0,b},startMouseListeners:function(){var a=this.app.engine.graphics;a.startListeners(),this.registerMouseDown()},stopMouseListeners:function(){var a=this.app.engine.graphics;a.stopListeners(),this.unregisterMouseDown()}}),extend(App.Engine.UI.prototype,{setupMouse:function(){this.buttons={left:1,middle:2,right:3},this.setupPointerLock()},getControls:function(a){var b;return"first-person"===a?(b=this.getFirstPersonControls(),b.type="fp"):b=void 0,b},startMouseListeners:function(){var a=this.app.engine.graphics;a.startListeners(),this.registerMouseDown()},stopMouseListeners:function(){var a=this.app.engine.graphics;a.stopListeners(),this.unregisterMouseDown()}}),extend(App.Engine.UI.prototype,{getFirstPersonControls:function(){var a=this.app.model.client,b=this.app.engine.graphics,c=this,d=function(d){if(c.threeControlsEnabled){var e=d.movementX||d.mozMovementX||d.webkitMovementX||0,f=d.movementY||d.mozMovementY||d.webkitMovementY||0,g=b.cameraManager.moveCameraFromMouse(e,f);a.triggerEvent("r",[g[0],g[1]])}};return{stopListeners:function(){document.removeEventListener("mousemove",d,!1)},startListeners:function(){document.addEventListener("mousemove",d,!1)}}}}),extend(App.Engine.UI.prototype,{getFirstPersonControls:function(){var a=this.app.model.client,b=this.app.engine.graphics,c=this,d=function(d){if(c.threeControlsEnabled){var e=d.movementX||d.mozMovementX||d.webkitMovementX||0,f=d.movementY||d.mozMovementY||d.webkitMovementY||0,g=b.cameraManager.moveCameraFromMouse(e,f);a.triggerEvent("r",[g[0],g[1]])}};return{stopListeners:function(){document.removeEventListener("mousemove",d,!1)},startListeners:function(){document.addEventListener("mousemove",d,!1)}}}}),extend(App.Engine.UI.prototype,{registerMouseDown:function(){var a=this,b=this.app;$(window).mousedown(function(c){if("ingame"===b.getState())switch(c.which){case a.buttons.left:a.onLeftMouseDown();break;case a.buttons.middle:a.onMiddleMouseDown();break;case a.buttons.right:a.onRightMouseDown()}})},onLeftMouseDown:function(){var a=this.app.model.client,b=this.app.engine.graphics,c=b.cameraManager.performRaycast();if(c.length<=0)return void console.log("Nothing intersected.");c.sort(function(a,b){return a.distance>b.distance});var d=c[0].point,e=Math.floor,f=Math.abs,g=b.getCameraCoordinates(),h=g.x,i=g.y,j=g.z,k=d.x,l=d.y,m=d.z,n=f(f(e(k))-f(k)),o=f(f(e(l))-f(l)),p=f(f(e(m))-f(m)),q=1e-7>n,r=1e-7>o,s=1e-7>p;if(q+r+s!==1)return void console.log("Error: precision on intersection @addBlock");var t,u,v;q?k>h?(t=k-1,u=e(l),v=e(m)):h>k&&(t=k,u=e(l),v=e(m)):r?l>i?(t=e(k),u=l-1,v=e(m)):i>l&&(t=e(k),u=l,v=e(m)):s&&(m>j?(t=e(k),u=e(l),v=m-1):j>m&&(t=e(k),u=e(l),v=m)),a.triggerEvent("ray",["add",t,u,v])},onRightMouseDown:function(){var a=this.app.model.client,b=this.app.engine.graphics,c=b.cameraManager.performRaycast();if(c.length<=0)return void console.log("Nothing intersected.");c.sort(function(a,b){return a.distance>b.distance});var d=c[0].point,e=Math.floor,f=Math.abs,g=b.getCameraCoordinates(),h=g.x,i=g.y,j=g.z,k=d.x,l=d.y,m=d.z,n=f(f(e(k))-f(k)),o=f(f(e(l))-f(l)),p=f(f(e(m))-f(m)),q=1e-7>n,r=1e-7>o,s=1e-7>p;if(q+r+s!==1)return void console.log("Error: precision on intersection @addBlock");var t,u,v;q?k>h?(t=k,u=e(l),v=e(m)):h>k&&(t=k-1,u=e(l),v=e(m)):r?l>i?(t=e(k),u=l,v=e(m)):i>l&&(t=e(k),u=l-1,v=e(m)):s&&(m>j?(t=e(k),u=e(l),v=m):j>m&&(t=e(k),u=e(l),v=m-1)),a.triggerEvent("ray",["del",t,u,v])},onMiddleMouseDown:function(){},unregisterMouseDown:function(){$(window).off("mousedown")}}),extend(App.Engine.UI.prototype,{registerMouseDown:function(){var a=this,b=this.app;$(window).mousedown(function(c){if("ingame"===b.getState())switch(c.which){case a.buttons.left:a.onLeftMouseDown();break;case a.buttons.middle:a.onMiddleMouseDown();break;case a.buttons.right:a.onRightMouseDown()}})},onLeftMouseDown:function(){var a=this.app.model.client,b=this.app.engine.graphics,c=b.cameraManager.performRaycast();if(c.length<=0)return void console.log("Nothing intersected.");c.sort(function(a,b){return a.distance>b.distance});var d=c[0].point,e=Math.floor,f=Math.abs,g=b.getCameraCoordinates(),h=g.x,i=g.y,j=g.z,k=d.x,l=d.y,m=d.z,n=f(f(e(k))-f(k)),o=f(f(e(l))-f(l)),p=f(f(e(m))-f(m)),q=1e-7>n,r=1e-7>o,s=1e-7>p;if(q+r+s!==1)return void console.log("Error: precision on intersection @addBlock");var t,u,v;q?k>h?(t=k-1,u=e(l),v=e(m)):h>k&&(t=k,u=e(l),v=e(m)):r?l>i?(t=e(k),u=l-1,v=e(m)):i>l&&(t=e(k),u=l,v=e(m)):s&&(m>j?(t=e(k),u=e(l),v=m-1):j>m&&(t=e(k),u=e(l),v=m)),a.triggerEvent("ray",["add",t,u,v])},onRightMouseDown:function(){var a=this.app.model.client,b=this.app.engine.graphics,c=b.cameraManager.performRaycast();if(c.length<=0)return void console.log("Nothing intersected.");c.sort(function(a,b){return a.distance>b.distance});var d=c[0].point,e=Math.floor,f=Math.abs,g=b.getCameraCoordinates(),h=g.x,i=g.y,j=g.z,k=d.x,l=d.y,m=d.z,n=f(f(e(k))-f(k)),o=f(f(e(l))-f(l)),p=f(f(e(m))-f(m)),q=1e-7>n,r=1e-7>o,s=1e-7>p;if(q+r+s!==1)return void console.log("Error: precision on intersection @addBlock");var t,u,v;q?k>h?(t=k,u=e(l),v=e(m)):h>k&&(t=k-1,u=e(l),v=e(m)):r?l>i?(t=e(k),u=l,v=e(m)):i>l&&(t=e(k),u=l-1,v=e(m)):s&&(m>j?(t=e(k),u=e(l),v=m):j>m&&(t=e(k),u=e(l),v=m-1)),a.triggerEvent("ray",["del",t,u,v])},onMiddleMouseDown:function(){},unregisterMouseDown:function(){$(window).off("mousedown")}}),extend(App.Engine.UI.prototype,{setupPointerLock:function(){var a=this.app;if("webkitPointerLockElement"in document||"mozPointerLockElement"in document||"pointerLockElement"in document){var b=this,c=document,d=document.body;"webkitPointerLockElement"in c?(d.requestPointerLock=d.webkitRequestPointerLock,c.addEventListener("webkitpointerlockchange",function(){b.pointerLockChanged(c.webkitRequestPointerLock===d)},!1)):"mozPointerLockElement"in c?(d.requestPointerLock=d.mozRequestPointerLock,c.addEventListener("mozpointerlockchange",function(){b.pointerLockChanged(c.mozPointerLockElement===d)},!1)):"pointerLockElement"in c?c.addEventListener("pointerlockchange",function(){b.pointerLockChanged(c.pointerLockElement===d)},!1):console.log("ERROR: POINTER LOCK NOT SUPPORTED."),$(document).mousedown(function(c){if("ingame"===a.getState()&&!a.isFocused()){switch(c.which){case 1:break;case 2:case 3:default:return}c.preventDefault(),c.stopPropagation(),b.requestPointerLock(),a.setFocused(!0)}})}},requestPointerLock:function(){var a=this.app.engine.controls,b=document.body;b.requestPointerLock(),a.startKeyboardListeners(),a.startMouseListeners()},pointerLockChanged:function(a){var b=this.app;b.engine.controls.threeControlsEnabled=a,a||(b.setState("settings"),b.setFocused(!1))}}),extend(App.Engine.UI.prototype,{setupPointerLock:function(){var a=this.app;if("webkitPointerLockElement"in document||"mozPointerLockElement"in document||"pointerLockElement"in document){var b=this,c=document,d=document.body;"webkitPointerLockElement"in c?(d.requestPointerLock=d.webkitRequestPointerLock,c.addEventListener("webkitpointerlockchange",function(){b.pointerLockChanged(c.webkitRequestPointerLock===d)},!1)):"mozPointerLockElement"in c?(d.requestPointerLock=d.mozRequestPointerLock,c.addEventListener("mozpointerlockchange",function(){b.pointerLockChanged(c.mozPointerLockElement===d)},!1)):"pointerLockElement"in c?c.addEventListener("pointerlockchange",function(){b.pointerLockChanged(c.pointerLockElement===d)},!1):console.log("ERROR: POINTER LOCK NOT SUPPORTED."),$(document).mousedown(function(c){if("ingame"===a.getState()&&!a.isFocused()){switch(c.which){case 1:break;case 2:case 3:default:return}c.preventDefault(),c.stopPropagation(),b.requestPointerLock(),a.setFocused(!0)}})}},requestPointerLock:function(){var a=this.app.engine.controls,b=document.body;b.requestPointerLock(),a.startKeyboardListeners(),a.startMouseListeners()},pointerLockChanged:function(a){var b=this.app;b.engine.controls.threeControlsEnabled=a,a||(b.setState("settings"),b.setFocused(!1))}}),extend(App.Engine.UI.prototype,{setupTouch:function(){},startTouchListeners:function(){this.registerTouch()},stopTouchListeners:function(){this.unregisterTouch()}}),extend(App.Engine.UI.prototype,{setupTouch:function(){},startTouchListeners:function(){this.registerTouch()},stopTouchListeners:function(){this.unregisterTouch()}}),extend(App.Engine.UI.prototype,{registerTouch:function(){$(window).on("touchstart",function(a){a.originalEvent}),$(window).on("touchmove",function(a){a.originalEvent}),$(window).on("touchend",function(a){a.originalEvent}),$(window).on("tap",function(a){}),$(window).on("swipe",function(a){}),$(window).on("swipeleft",function(a){}),$(window).on("swiperight",function(a){})},unregisterTouch:function(){$(window).off("touchstart"),$(window).off("touchend"),$(window).off("touchmove"),$(window).on("tap"),$(window).on("swipe"),$(window).on("swipeleft"),$(window).on("swiperight")}}),extend(App.Engine.UI.prototype,{registerTouch:function(){$(window).on("touchstart",function(a){a.originalEvent}),$(window).on("touchmove",function(a){a.originalEvent}),$(window).on("touchend",function(a){a.originalEvent}),$(window).on("tap",function(a){}),$(window).on("swipe",function(a){}),$(window).on("swipeleft",function(a){}),$(window).on("swiperight",function(a){})},unregisterTouch:function(){$(window).off("touchstart"),$(window).off("touchend"),$(window).off("touchmove"),
$(window).on("tap"),$(window).on("swipe"),$(window).on("swipeleft"),$(window).on("swiperight")}}),App.Engine.Graphics=function(a){this.app=a,this.debug=!1,this.windowHalfX=window.innerWidth/2,this.windowHalfY=window.innerHeight/2,this.defaultGeometrySize=64,this.requestId=null,this.sceneManager=this.createSceneManager(),this.rendererManager=this.createRendererManager(),this.cameraManager=this.createCameraManager(),this.controls=null,this.container=document.getElementById("container"),this.container.appendChild(this.rendererManager.renderer.domElement),this.fps=new Stats,this.initializeAnimations(),this.loadTextures()},extend(App.Engine.Graphics.prototype,{run:function(){this.initializeControls(),this.resize(),this.animate()},animate:function(){var a=this.app.model.client,b=this.app.model.server;this.requestId=requestAnimationFrame(this.animate.bind(this)),this.fps.update(),b.refresh(),this.render(),a.refresh()},render:function(){var a=this.sceneManager,b=this.cameraManager,c=this.app.model.server.xModel.portals;this.rendererManager.render(a,b,c)},stop:function(){this.requestId&&cancelAnimationFrame(this.requestId)},resize:function(){var a=window.innerWidth,b=window.innerHeight;this.cameraManager.resize(a,b),this.rendererManager.resize(a,b),this.sceneManager.resize(a,b)},getCameraInteraction:function(){return this.app.model.client.getCameraInteraction()}}),App.Engine.Graphics=function(a){this.app=a,this.debug=!1,this.windowHalfX=window.innerWidth/2,this.windowHalfY=window.innerHeight/2,this.defaultGeometrySize=64,this.requestId=null,this.sceneManager=this.createSceneManager(),this.rendererManager=this.createRendererManager(),this.cameraManager=this.createCameraManager(),this.controls=null,this.container=document.getElementById("container"),this.container.appendChild(this.rendererManager.renderer.domElement),this.fps=new Stats,this.initializeAnimations(),this.loadTextures()},extend(App.Engine.Graphics.prototype,{run:function(){this.initializeControls(),this.resize(),this.animate()},animate:function(){var a=this.app.model.client,b=this.app.model.server;this.requestId=requestAnimationFrame(this.animate.bind(this)),this.fps.update(),b.refresh(),this.render(),a.refresh()},render:function(){var a=this.sceneManager,b=this.cameraManager,c=this.app.model.server.xModel.portals;this.rendererManager.render(a,b,c)},stop:function(){this.requestId&&cancelAnimationFrame(this.requestId)},resize:function(){var a=window.innerWidth,b=window.innerHeight;this.cameraManager.resize(a,b),this.rendererManager.resize(a,b),this.sceneManager.resize(a,b)},getCameraInteraction:function(){return this.app.model.client.getCameraInteraction()}}),extend(App.Engine.Graphics.prototype,{initializeControls:function(){var a=this.app.engine.controls,b=this.app.model.server.selfModel,c=b.worldId;this.controls=a.getControls("first-person"),this.addToScene(this.cameraManager.mainCamera.get3DObject(),c),this.addToScene(this.cameraManager.mainRaycasterCamera.get3DObject(),c)},startListeners:function(){this.controls.startListeners()},stopListeners:function(){this.controls.stopListeners()},changeAvatarVisibility:function(a,b,c){a?this.addToScene(b,c):this.removeFromScene(b,c)}}),extend(App.Engine.Graphics.prototype,{initializeControls:function(){var a=this.app.engine.controls,b=this.app.model.server.selfModel,c=b.worldId;this.controls=a.getControls("first-person"),this.addToScene(this.cameraManager.mainCamera.get3DObject(),c),this.addToScene(this.cameraManager.mainRaycasterCamera.get3DObject(),c)},startListeners:function(){this.controls.startListeners()},stopListeners:function(){this.controls.stopListeners()},changeAvatarVisibility:function(a,b,c){a?this.addToScene(b,c):this.removeFromScene(b,c)}}),extend(App.Engine.Graphics.prototype,{initializeAnimations:function(){this.prevTime=Date.now(),this.mixers=new Map},updateAnimation:function(a){var b=this.mixers.get(a);if(void 0!==b){var c=Date.now();b.update(.001*(c-this.prevTime)),this.prevTime=c}}}),extend(App.Engine.Graphics.prototype,{initializeAnimations:function(){this.prevTime=Date.now(),this.mixers=new Map},updateAnimation:function(a){var b=this.mixers.get(a);if(void 0!==b){var c=Date.now();b.update(.001*(c-this.prevTime)),this.prevTime=c}}}),extend(App.Engine.Graphics.prototype,{initializeEntity:function(a,b,c){var d=new THREE.JSONLoader,e=this.mixers;d.load("app/assets/models/"+b+".json",function(b){var d=new THREE.Mesh(b,new THREE.MeshLambertMaterial({vertexColors:THREE.FaceColors,morphTargets:!0}));d.scale.set(1,1,1);var f=new THREE.AnimationMixer(d),g=THREE.AnimationClip.CreateFromMorphTargetSequence("run",b.morphTargets,30);f.clipAction(g).setDuration(1).play(),e.set(a,f),c(d)})},finalizeEntity:function(a,b){var c=new THREE.Object3D,d=this.createMesh(this.createGeometry("box"),this.createMaterial("flat-phong"));return c.add(b),c.add(d),d.position.y=1.6,c.rotation.x=Math.PI/2,c.rotation.y=Math.PI,c._id=a,c}}),extend(App.Engine.Graphics.prototype,{initializeEntity:function(a,b,c){var d=new THREE.JSONLoader,e=this.mixers;d.load("app/assets/models/"+b+".json",function(b){var d=new THREE.Mesh(b,new THREE.MeshLambertMaterial({vertexColors:THREE.FaceColors,morphTargets:!0}));d.scale.set(1,1,1);var f=new THREE.AnimationMixer(d),g=THREE.AnimationClip.CreateFromMorphTargetSequence("run",b.morphTargets,30);f.clipAction(g).setDuration(1).play(),e.set(a,f),c(d)})},finalizeEntity:function(a,b){var c=new THREE.Object3D,d=this.createMesh(this.createGeometry("box"),this.createMaterial("flat-phong"));return c.add(b),c.add(d),d.position.y=1.6,c.rotation.x=Math.PI/2,c.rotation.y=Math.PI,c._id=a,c}}),extend(App.Engine.Graphics.prototype,{createLight:function(a){var b;switch(a){case"hemisphere":b=new THREE.HemisphereLight(15658751,7829384,.75);break;default:b=new THREE.AmbientLight(4210752)}return b}}),extend(App.Engine.Graphics.prototype,{createLight:function(a){var b;switch(a){case"hemisphere":b=new THREE.HemisphereLight(15658751,7829384,.75);break;default:b=new THREE.AmbientLight(4210752)}return b}}),extend(App.Engine.Graphics.prototype,{createMaterial:function(a,b){var c;switch(a){case"flat-phong":c=new THREE.MeshPhongMaterial({specular:16777215,shading:THREE.FlatShading,vertexColors:THREE.VertexColors});break;case"textured-phong":c=new THREE.MeshLambertMaterial({side:THREE.BackSide,map:this.texture});break;case"basic-black":c=new THREE.MeshBasicMaterial({wireframe:!0,color:0});break;default:c=new THREE.MeshBasicMaterial({color:16711680})}return c}}),extend(App.Engine.Graphics.prototype,{createMaterial:function(a,b){var c;switch(a){case"flat-phong":c=new THREE.MeshPhongMaterial({specular:16777215,shading:THREE.FlatShading,vertexColors:THREE.VertexColors});break;case"textured-phong":c=new THREE.MeshLambertMaterial({side:THREE.BackSide,map:this.texture});break;case"basic-black":c=new THREE.MeshBasicMaterial({wireframe:!0,color:0});break;default:c=new THREE.MeshBasicMaterial({color:16711680})}return c}}),extend(App.Engine.Graphics.prototype,{createGeometry:function(a){var b;switch(a){case"plane":b=new THREE.PlaneGeometry(32,32,32,32);break;case"box":b=new THREE.BoxGeometry(.45,.45,.45);break;default:b=new THREE.BoxGeometry(.5,.5,1)}return b},createMesh:function(a,b){return new THREE.Mesh(a,b)}}),extend(App.Engine.Graphics.prototype,{createGeometry:function(a){var b;switch(a){case"plane":b=new THREE.PlaneGeometry(32,32,32,32);break;case"box":b=new THREE.BoxGeometry(.45,.45,.45);break;default:b=new THREE.BoxGeometry(.5,.5,1)}return b},createMesh:function(a,b){return new THREE.Mesh(a,b)}});var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(a){return typeof a}:function(a){return a&&"function"==typeof Symbol&&a.constructor===Symbol?"symbol":typeof a};extend(App.Engine.Graphics.prototype,{addStubPortalObject:function(a){var b=a.worldId,c=a.portalId;console.log("Adding stub: p("+c+"), w("+b+")");var d=this.getScene(b);if(!d)return void console.log("Could not load scene from "+b+" ("+("undefined"==typeof b?"undefined":_typeof(b))+")");var e=this.getScreen(c);if(!e){var f=a.tempPosition,g=a.tempWidth,h=a.tempHeight,i=window.innerWidth,j=window.innerHeight,k=new THREE.WebGLRenderTarget(i,j,{minFilter:THREE.LinearFilter,magFilter:THREE.NearestFilter,format:THREE.RGBFormat}),l=new THREE.PlaneBufferGeometry(g,h),m=l.attributes.uv.array,n=0;m[n++]=1,m[n++]=1,m[n++]=0,m[n++]=1,m[n++]=1,m[n++]=0,m[n++]=0,m[n++]=0;var o=this.getPortalVertexShader(),p=this.getPortalFragmentShader(),q=new THREE.ShaderMaterial({side:THREE.DoubleSide,uniforms:{texture1:{type:"t",value:k.texture}},vertexShader:o,fragmentShader:p}),r=new THREE.Mesh(l,q);r.position.x=f[0]+.5,r.position.y=f[1],r.position.z=f[2]+1,r.rotation.x=Math.PI/2,e=new App.Engine.Graphics.Screen(c,r,k),this.addScreen(c,e)}e&&this.addToScene(e.getMesh(),b)},completeStubPortalObject:function(a,b){var c=a.worldId,d=a.portalId;a.portalLinkedForward=b.portalId,console.log("Completing stub: p("+d+"), w("+c+"), f("+b.portalId+")");var e=this.getScreen(d);if(!e||!e.isLinked())return void console.log("A completed stub cannot be completed again: "+d);var f=b.worldId;e.setOtherWorldId(f),this.cameraManager.addCamera(a,b),this.cameraManager.addCameraToScene(d,c);this.getScene(f)},addPortalObject:function(a,b){a.worldId;this.addStubPortalObject(a),this.completeStubPortalObject(a,b)},removePartOfPortalObject:function(a,b){a.worldId},removePortalObject:function(a){a.worldId}}),extend(App.Engine.Graphics.prototype,{addStubPortalObject:function(a){var b=a.worldId,c=a.portalId;console.log("Adding stub: p("+c+"), w("+b+")");var d=this.getScene(b);if(!d)return void console.log("Could not load scene from "+b+" ("+typeof b+")");var e=this.getScreen(c);if(!e){var f=a.tempPosition,g=a.tempWidth,h=a.tempHeight,i=window.innerWidth,j=window.innerHeight,k=new THREE.WebGLRenderTarget(i,j,{minFilter:THREE.LinearFilter,magFilter:THREE.NearestFilter,format:THREE.RGBFormat}),l=new THREE.PlaneBufferGeometry(g,h),m=l.attributes.uv.array,n=0;m[n++]=1,m[n++]=1,m[n++]=0,m[n++]=1,m[n++]=1,m[n++]=0,m[n++]=0,m[n++]=0;var o=this.getPortalVertexShader(),p=this.getPortalFragmentShader(),q=new THREE.ShaderMaterial({side:THREE.DoubleSide,uniforms:{texture1:{type:"t",value:k.texture}},vertexShader:o,fragmentShader:p}),r=new THREE.Mesh(l,q);r.position.x=f[0]+.5,r.position.y=f[1],r.position.z=f[2]+1,r.rotation.x=Math.PI/2,e=new App.Engine.Graphics.Screen(c,r,k),this.addScreen(c,e)}e&&this.addToScene(e.getMesh(),b)},completeStubPortalObject:function(a,b){var c=a.worldId,d=a.portalId;a.portalLinkedForward=b.portalId,console.log("Completing stub: p("+d+"), w("+c+"), f("+b.portalId+")");var e=this.getScreen(d);if(!e||!e.isLinked())return void console.log("A completed stub cannot be completed again: "+d);var f=b.worldId;e.setOtherWorldId(f),this.cameraManager.addCamera(a,b),this.cameraManager.addCameraToScene(d,c);this.getScene(f)},addPortalObject:function(a,b){a.worldId;this.addStubPortalObject(a),this.completeStubPortalObject(a,b)},removePartOfPortalObject:function(a,b){a.worldId},removePortalObject:function(a){a.worldId}}),App.Engine.Graphics.Screen=function(a,b,c){this.screenId=a,this.mesh=b,this.renderTarget=c,this.otherWorldId=null},extend(App.Engine.Graphics.Screen.prototype,{getId:function(){return this.screenId},getMesh:function(){return this.mesh},getRenderTarget:function(){return this.renderTarget},getOtherWorldId:function(){return this.otherWorldId},setOtherWorldId:function(a){this.otherWorldId=a},isLinked:function(){return null!==this.otherWorldId||void 0!==this.otherWorldId}}),App.Engine.Graphics.Screen=function(a,b,c){this.screenId=a,this.mesh=b,this.renderTarget=c,this.otherWorldId=null},extend(App.Engine.Graphics.Screen.prototype,{getId:function(){return this.screenId},getMesh:function(){return this.mesh},getRenderTarget:function(){return this.renderTarget},getOtherWorldId:function(){return this.otherWorldId},setOtherWorldId:function(a){this.otherWorldId=a},isLinked:function(){return null!==this.otherWorldId||void 0!==this.otherWorldId}}),App.Engine.Graphics.Camera=function(a,b,c,d){var e=new THREE.PerspectiveCamera(a,b,c,d);e.position.set(0,0,0),e.rotation.set(0,0,0);var f=new THREE.Object3D,g=new THREE.Object3D;f.add(e),g.add(f),this.yaw=g,this.pitch=f,this.cameraObject=e},extend(App.Engine.Graphics.Camera.prototype,{getRecorder:function(){return this.cameraObject},get3DObject:function(){return this.yaw},getCameraPosition:function(){return this.yaw.position},rotateX:function(a){var b=this.pitch;b.rotation.x+=a,b.rotation.x=Math.max(0,Math.min(Math.PI,b.rotation.x))},rotateZ:function(a){var b=this.yaw;b.rotation.z+=a},getXRotation:function(){return this.pitch.rotation.x},setXRotation:function(a){this.pitch.rotation.x=a},getZRotation:function(){return this.yaw.rotation.z},setZRotation:function(a){this.yaw.rotation.z=a},setCameraPosition:function(a,b,c){var d=this.yaw;d.position.x=a,d.position.y=b,d.position.z=c},setFirstPerson:function(){this.cameraObject.position.z=0},setThirdPerson:function(){this.cameraObject.position.z=4}}),App.Engine.Graphics.Camera=function(a,b,c,d){var e=new THREE.PerspectiveCamera(a,b,c,d);e.position.set(0,0,0),e.rotation.set(0,0,0);var f=new THREE.Object3D,g=new THREE.Object3D;f.add(e),g.add(f),this.yaw=g,this.pitch=f,this.cameraObject=e},extend(App.Engine.Graphics.Camera.prototype,{getRecorder:function(){return this.cameraObject},get3DObject:function(){return this.yaw},getCameraPosition:function(){return this.yaw.position},rotateX:function(a){var b=this.pitch;b.rotation.x+=a,b.rotation.x=Math.max(0,Math.min(Math.PI,b.rotation.x))},rotateZ:function(a){var b=this.yaw;b.rotation.z+=a},getXRotation:function(){return this.pitch.rotation.x},setXRotation:function(a){this.pitch.rotation.x=a},getZRotation:function(){return this.yaw.rotation.z},setZRotation:function(a){this.yaw.rotation.z=a},setCameraPosition:function(a,b,c){var d=this.yaw;d.position.x=a,d.position.y=b,d.position.z=c},setFirstPerson:function(){this.cameraObject.position.z=0},setThirdPerson:function(){this.cameraObject.position.z=4}}),App.Engine.Graphics.CameraManager=function(a){this.graphicsEngine=a,this.mainFOV=90,this.mainAspect=window.innerWidth/window.innerHeight,this.mainNear=1e-4,this.mainFar=1e5,this.mainCamera=this.createCamera(!1),this.subCameras=new Map,this.mainRaycasterCamera=this.createCamera(!0),this.raycaster=this.createRaycaster()},extend(App.Engine.Graphics.CameraManager.prototype,{createCamera:function(a){return this.mainAspect=window.innerWidth/window.innerHeight,new App.Engine.Graphics.Camera(this.mainFOV,this.mainAspect,a?1:this.mainNear,this.mainFar)},addCamera:function(a,b){var c=a.portalId;if(this.subCameras.has(c))return void console.log("Camera "+c+" cannot be added a second time.");var d=this.mainCamera,e=this.createCamera(!1);this.subCameras.set(c,e);var f=d.getCameraPosition();e.setCameraPosition(f.x,f.y,f.z),e.setZRotation(d.getZRotation()),e.setXRotation(d.getXRotation())},addCameraToScene:function(a,b){var c=this.subCameras.get(a);return c?void this.graphicsEngine.addToScene(c.get3DObject(),b):void console.log("Could not get wrapper for camera "+a)},switchToCamera:function(a){var b=this.subCameras.get(a);if(!b)return void console.log("Failed to switch with camera "+a);this.mainCamera;this.mainCamera=b},updateCameraPosition:function(a){var b=[this.mainCamera,this.mainRaycasterCamera];this.subCameras.forEach(function(a){b.push(a)});var c=this.graphicsEngine.getCameraInteraction(),d=a[0],e=a[1],f=a[2]+1.6;c.isFirstPerson()?b.forEach(function(a,b){a.setCameraPosition(d,e,f),a.setFirstPerson()}):c.isThirdPerson()&&b.forEach(function(a,b){a.setCameraPosition(d,e,f+.2),a.setThirdPerson()})},moveCameraFromMouse:function(a,b){var c=this.mainCamera;c.rotateZ(.002*-a),c.rotateX(.002*-b);var d=c.getZRotation(),e=c.getXRotation(),f=this.mainRaycasterCamera;return f.setZRotation(d),f.setXRotation(e),this.subCameras.forEach(function(a,b){a.setZRotation(d),a.setXRotation(e)}),[d,e]},resize:function(a,b){var c=a/b,d=this.mainCamera.getRecorder();d.aspect=c,d.updateProjectionMatrix();var e=this.mainRaycasterCamera.getRecorder();e.aspect=c,e.updateProjectionMatrix(),this.subCameras.forEach(function(a,b){var d=a.getRecorder();d.aspect=c,d.updateProjectionMatrix()})},createRaycaster:function(){return new THREE.Raycaster},performRaycast:function(){var a,b=this.graphicsEngine,c=b.app.model.server.chunkModel,d=b.app.model.server.selfModel,e=this.raycaster,f=this.mainRaycasterCamera.getRecorder(),g=c.getCloseTerrain(d.worldId);return e.setFromCamera(new THREE.Vector2(0,0),f),a=e.intersectObjects(g)}}),extend(App.Engine.Graphics.prototype,{createCameraManager:function(){return new App.Engine.Graphics.CameraManager(this)},getCameraCoordinates:function(){return this.cameraManager.mainCamera.getCameraPosition()}}),App.Engine.Graphics.CameraManager=function(a){this.graphicsEngine=a,this.mainFOV=90,this.mainAspect=window.innerWidth/window.innerHeight,this.mainNear=1e-4,this.mainFar=1e5,this.mainCamera=this.createCamera(!1),this.subCameras=new Map,this.mainRaycasterCamera=this.createCamera(!0),this.raycaster=this.createRaycaster()},extend(App.Engine.Graphics.CameraManager.prototype,{createCamera:function(a){return this.mainAspect=window.innerWidth/window.innerHeight,new App.Engine.Graphics.Camera(this.mainFOV,this.mainAspect,a?1:this.mainNear,this.mainFar)},addCamera:function(a,b){var c=a.portalId;if(this.subCameras.has(c))return void console.log("Camera "+c+" cannot be added a second time.");var d=this.mainCamera,e=this.createCamera(!1);this.subCameras.set(c,e);var f=d.getCameraPosition();e.setCameraPosition(f.x,f.y,f.z),e.setZRotation(d.getZRotation()),e.setXRotation(d.getXRotation())},addCameraToScene:function(a,b){var c=this.subCameras.get(a);return c?void this.graphicsEngine.addToScene(c.get3DObject(),b):void console.log("Could not get wrapper for camera "+a)},switchToCamera:function(a){var b=this.subCameras.get(a);if(!b)return void console.log("Failed to switch with camera "+a);this.mainCamera;this.mainCamera=b},updateCameraPosition:function(a){var b=[this.mainCamera,this.mainRaycasterCamera];this.subCameras.forEach(function(a){b.push(a)});var c=this.graphicsEngine.getCameraInteraction(),d=a[0],e=a[1],f=a[2]+1.6;c.isFirstPerson()?b.forEach(function(a,b){a.setCameraPosition(d,e,f),a.setFirstPerson()}):c.isThirdPerson()&&b.forEach(function(a,b){a.setCameraPosition(d,e,f+.2),a.setThirdPerson()})},moveCameraFromMouse:function(a,b){var c=this.mainCamera;c.rotateZ(.002*-a),c.rotateX(.002*-b);var d=c.getZRotation(),e=c.getXRotation(),f=this.mainRaycasterCamera;return f.setZRotation(d),f.setXRotation(e),this.subCameras.forEach(function(a,b){a.setZRotation(d),a.setXRotation(e)}),[d,e]},resize:function(a,b){var c=a/b,d=this.mainCamera.getRecorder();d.aspect=c,d.updateProjectionMatrix();var e=this.mainRaycasterCamera.getRecorder();e.aspect=c,e.updateProjectionMatrix(),this.subCameras.forEach(function(a,b){var d=a.getRecorder();d.aspect=c,d.updateProjectionMatrix()})},createRaycaster:function(){return new THREE.Raycaster},performRaycast:function(){var a,b=this.graphicsEngine,c=b.app.model.server.chunkModel,d=b.app.model.server.selfModel,e=this.raycaster,f=this.mainRaycasterCamera.getRecorder(),g=c.getCloseTerrain(d.worldId);return e.setFromCamera(new THREE.Vector2(0,0),f),a=e.intersectObjects(g)}}),extend(App.Engine.Graphics.prototype,{createCameraManager:function(){return new App.Engine.Graphics.CameraManager(this)},getCameraCoordinates:function(){return this.cameraManager.mainCamera.getCameraPosition()}}),App.Engine.Graphics.RendererManager=function(){this.renderMax=Number.POSITIVE_INFINITY,this.renderer=this.createRenderer()},extend(App.Engine.Graphics.RendererManager.prototype,{createRenderer:function(){var a=new THREE.WebGLRenderer({antialias:!0,alpha:!0});return a.setClearColor(4414836,1),a.setSize(window.innerWidth,window.innerHeight),a},render:function(a,b,c){var d=this.renderer,e=a.mainScene,f=b.mainCamera.getRecorder();d.render(e,f);var g=a.subScenes,h=b.subCameras,i=a.screens,j=0,k=this.renderMax;i.forEach(function(b,e){if(!b.isLinked())return void console.log("Not rendering screen "+e);if(!(j>k)){var f=b.getRenderTarget();if(!f)return void console.log("Could not get matching RTT.");var l=h.get(e);if(!l)return void console.log("Could not get matching camera.");l=l.getRecorder();var m=b.getOtherWorldId(),n=g.get(m);if(n){var o=c.get(e);if(o){var p=i.get(o.portalLinkedForward),q=null;p&&(q=p.getMesh()),q&&a.removeObject(q,m),d.render(n,l,f),q&&a.addObject(q,m),++j}}}}),j>0&&d.render(e,f)},resize:function(a,b){a||(a=window.innerWidth),b||(b=window.innerHeight),this.renderer.setSize(a,b)}}),extend(App.Engine.Graphics.prototype,{createRendererManager:function(){return new App.Engine.Graphics.RendererManager}}),App.Engine.Graphics.RendererManager=function(){this.renderMax=Number.POSITIVE_INFINITY,this.renderer=this.createRenderer()},extend(App.Engine.Graphics.RendererManager.prototype,{createRenderer:function(){var a=new THREE.WebGLRenderer({antialias:!0,alpha:!0});return a.setClearColor(4414836,1),a.setSize(window.innerWidth,window.innerHeight),a},render:function(a,b,c){var d=this.renderer,e=a.mainScene,f=b.mainCamera.getRecorder();d.render(e,f);var g=a.subScenes,h=b.subCameras,i=a.screens,j=0,k=this.renderMax;i.forEach(function(b,e){if(!b.isLinked())return void console.log("Not rendering screen "+e);if(!(j>k)){var f=b.getRenderTarget();if(!f)return void console.log("Could not get matching RTT.");var l=h.get(e);if(!l)return void console.log("Could not get matching camera.");l=l.getRecorder();var m=b.getOtherWorldId(),n=g.get(m);if(n){var o=c.get(e);if(o){var p=i.get(o.portalLinkedForward),q=null;p&&(q=p.getMesh()),q&&a.removeObject(q,m),d.render(n,l,f),q&&a.addObject(q,m),++j}}}}),j>0&&d.render(e,f)},resize:function(a,b){a||(a=window.innerWidth),b||(b=window.innerHeight),this.renderer.setSize(a,b)}}),extend(App.Engine.Graphics.prototype,{createRendererManager:function(){return new App.Engine.Graphics.RendererManager}}),App.Engine.Graphics.SceneManager=function(){this.mainScene=this.createScene("-1"),this.subScenes=new Map,this.screens=new Map},extend(App.Engine.Graphics.SceneManager.prototype,{createScene:function(a){var b=new THREE.Scene;return b.sceneId=a,b},addScene:function(a,b){return b||(b=this.createScene(a)),this.subScenes.set(a,b),b},switchToScene:function(a){var b=this.subScenes.get(a);if(!b)return void console.log("Failed to switch to scene "+a);var c=this.mainScene,d=c.sceneId;this.mainScene=b,this.subScenes["delete"](a),this.addScene(d,c)},addObject:function(a,b){var c=this.getScene(b);c&&c.add(a)},removeObject:function(a,b){var c=this.getScene(b);c&&(c.remove(a),a.geometry&&(a.geometry.dispose(),a.geometry=null),a.material&&(a.material.dispose(),a.material=null))},getScene:function(a){return a==this.mainScene.sceneId?this.mainScene:this.subScenes.get(a)},resize:function(a,b){a||(a=window.innerWidth),b||(b=window.innerHeight);var c=this.screens;c.forEach(function(c,d){if(!c.isLinked())return void console.log("Not resizing screen "+d);var e=c.getRenderTarget();e.setSize(a,b)})}}),extend(App.Engine.Graphics.prototype,{createSceneManager:function(){return new App.Engine.Graphics.SceneManager(this)},addToScene:function(a,b){var c=this.sceneManager;b||(b=c.mainScene.sceneId),b=parseInt(b),c.addObject(a,b)},removeFromScene:function(a,b){var c=this.sceneManager;b||(b=c.mainScene.sceneId),b=parseInt(b),c.removeObject(a,b)},addScene:function(a){a=parseInt(a);var b=this.sceneManager;return a==b.mainScene.sceneId||b.subScenes.has(a)?void console.log("Trying to add an existing scene: "+a):b.addScene(a)},forgetScene:function(a){var b=this.sceneManager;return a!=b.mainScene.sceneId&&b.subScenes.has(a)?void this.subScenes["delete"](a):void console.log("Trying to delete main scene or unknown scene: "+a)},getScene:function(a){return this.sceneManager.getScene(a)},addScreen:function(a,b){this.sceneManager.screens.set(a,b)},getScreen:function(a){return this.sceneManager.screens.get(a)}}),App.Engine.Graphics.SceneManager=function(){this.mainScene=this.createScene("-1"),this.subScenes=new Map,this.screens=new Map},extend(App.Engine.Graphics.SceneManager.prototype,{createScene:function(a){var b=new THREE.Scene;return b.sceneId=a,b},addScene:function(a,b){return b||(b=this.createScene(a)),this.subScenes.set(a,b),b},switchToScene:function(a){var b=this.subScenes.get(a);if(!b)return void console.log("Failed to switch to scene "+a);var c=this.mainScene,d=c.sceneId;this.mainScene=b,this.subScenes["delete"](a),this.addScene(d,c)},addObject:function(a,b){var c=this.getScene(b);c&&c.add(a)},removeObject:function(a,b){var c=this.getScene(b);c&&(c.remove(a),a.geometry&&(a.geometry.dispose(),a.geometry=null),a.material&&(a.material.dispose(),a.material=null))},getScene:function(a){return a==this.mainScene.sceneId?this.mainScene:this.subScenes.get(a)},resize:function(a,b){a||(a=window.innerWidth),b||(b=window.innerHeight);var c=this.screens;c.forEach(function(c,d){if(!c.isLinked())return void console.log("Not resizing screen "+d);var e=c.getRenderTarget();e.setSize(a,b)})}}),extend(App.Engine.Graphics.prototype,{createSceneManager:function(){return new App.Engine.Graphics.SceneManager(this)},addToScene:function(a,b){var c=this.sceneManager;b||(b=c.mainScene.sceneId),b=parseInt(b),c.addObject(a,b)},removeFromScene:function(a,b){var c=this.sceneManager;b||(b=c.mainScene.sceneId),b=parseInt(b),c.removeObject(a,b)},addScene:function(a){a=parseInt(a);var b=this.sceneManager;return a==b.mainScene.sceneId||b.subScenes.has(a)?void console.log("Trying to add an existing scene: "+a):b.addScene(a)},forgetScene:function(a){var b=this.sceneManager;return a!=b.mainScene.sceneId&&b.subScenes.has(a)?void this.subScenes["delete"](a):void console.log("Trying to delete main scene or unknown scene: "+a)},getScene:function(a){return this.sceneManager.getScene(a)},addScreen:function(a,b){this.sceneManager.screens.set(a,b)},getScreen:function(a){return this.sceneManager.screens.get(a)}}),extend(App.Engine.Graphics.prototype,{getPortalVertexShader:function(){return["varying vec4 pos_frag;","","void main() {","","pos_frag = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","gl_Position = pos_frag;","}"].join("\n")},getPortalFragmentShader:function(){return["uniform sampler2D texture1;","varying vec4 pos_frag;","","void main() {","","vec2 ratio = pos_frag.xy / pos_frag.w;","vec2 correctedUv = (ratio + vec2(1.0))*0.5;","gl_FragColor = texture2D( texture1, correctedUv );","}"].join("\n")}}),extend(App.Engine.Graphics.prototype,{getPortalVertexShader:function(){return["varying vec4 pos_frag;","","void main() {","","pos_frag = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","gl_Position = pos_frag;","}"].join("\n")},getPortalFragmentShader:function(){return["uniform sampler2D texture1;","varying vec4 pos_frag;","","void main() {","","vec2 ratio = pos_frag.xy / pos_frag.w;","vec2 correctedUv = (ratio + vec2(1.0))*0.5;","gl_FragColor = texture2D( texture1, correctedUv );","}"].join("\n")}}),extend(App.Engine.Graphics.prototype,{createChunk:function(a,b,c,d,e){var f,g,h=b[0],i=b[1];for(var j in h){f=h[j],g=i[j];break}if(!f)return void console.log("Warn: missed an update");var k=a.split(","),l=parseInt(k[0]),m=l*c,n=parseInt(k[1]),o=n*d,p=parseInt(k[2]),q=p*e,r=c,s=c*d,t=s*e,u=2*f.length,v=Math.floor(1.5*u);v+=v%2,this.debug&&console.log("On chunk "+a+", init geometry will be "+3*v*3+"-capable.");for(var w=new Float32Array(3*v*3),x=new Float32Array(3*v*3),y=new Float32Array(3*v*3),z=new Float32Array(3*v*2),A=new THREE.Vector3,B=new THREE.Vector3,C=new THREE.Vector3,D=new THREE.Vector3,E=new THREE.Vector3,F=new THREE.Color,G=new Map,H=new Map,I=0,J=0;J<f.length;++J){var K=Math.abs(f[J]);G.set(K,[0,J]);var L=H.get(0);void 0===L&&(L=new Map,H.set(0,L)),L.set(J,K);var M=g[J]>0;this.addFace(K,I,r,s,t,w,x,y,z,Math.abs(g[J]),m,o,q,A,B,C,D,E,M,F),I+=18}var N=new THREE.BufferGeometry;N.addAttribute("position",new THREE.BufferAttribute(w,3)),N.addAttribute("normal",new THREE.BufferAttribute(x,3)),N.addAttribute("color",new THREE.BufferAttribute(y,3)),N.addAttribute("uv",new THREE.BufferAttribute(z,2)),N.computeBoundingSphere();var O=this.createMaterial("textured-phong",11184810);return{geometries:[N],materials:[O],meshes:[new THREE.Mesh(N,O)],capacities:[v/2],sizes:[u/2],whereToFindFace:G,whichFaceIs:H}},updateChunk:function(a,b,c,d,e,f,g){var h=b.geometries,i=b.materials,j=b.meshes,k=b.capacities,l=b.sizes,m=b.whereToFindFace,n=b.whichFaceIs,o=d[0],p=d[1],q=d[2];this.removeChunkFaces(a,o,h,i,j,k,l,m,n),this.addChunkFaces(a,p,h,i,j,k,l,m,n,c,e,f,g),this.updateChunkFaces(a,q,h)},removeChunkFaces:function(a,b,c,d,e,f,g,h,i){var j,k,l,m,n,o;for(var p in b)if(p=parseInt(p),h.has(p)){var q=h.get(p);o=q[0];var r=q[1];j=c[o],k=j.attributes.position.array,l=j.attributes.color.array,m=j.attributes.normal.array,n=j.attributes.uv.array;var s,t,u=g[o]-1,v=u===r;if(v){for(s=0;18>s;++s)t=18*r+s,k[t]=m[t]=l[t]=0;for(s=0;12>s;++s)n[12*r+s]=0}else{for(s=0;18>s;++s){t=18*r+s;var w=18*u+s;k[t]=k[w],m[t]=m[w],l[t]=l[w],k[w]=m[w]=l[w]=0}for(s=0;12>s;++s){t=12*r+s;var x=12*u+s;n[t]=n[x],n[x]=0}}if(!v){var y=i.get(o);void 0===y.get(u)&&(console.log("WARN: swapping"),console.log(i[o][u]+" @mesh "+o+" @lastposition "+u+" @position "+r)),h.set(y.get(u),[o,r]),y.set(r,y.get(u))}i.get(o)["delete"](u),h["delete"](p),g[o]-=1,0===g[o]?(console.log("INFO: geometry deletion."),this.sceneManager.removeFromScene(e[o],a),c[o]=void 0,d[o]=void 0,e[o]=void 0,g[o]=void 0,f[o]=void 0,i["delete"](o)):(j.attributes.position.needsUpdate=!0,j.attributes.color.needsUpdate=!0,j.attributes.normal.needsUpdate=!0,j.attributes.uv.needsUpdate=!0,j.computeBoundingSphere())}else console.log("Trying to remove a face that is not present in chunk: "+p)},addChunkFaces:function(a,b,c,d,e,f,g,h,i,j,k,l,m){var n,o,p,q,r,s,t,u=k,v=k*l,w=v*m,x=j.split(","),y=parseInt(x[0]),z=y*k,A=parseInt(x[1]),B=A*l,C=parseInt(x[2]),D=C*m,E=this.defaultGeometrySize;for(var F in b)if(F=parseInt(F),t=Math.abs(F),h.hasOwnProperty(t))console.log("Trying to add a face that is already present in chunk.");else{s=0;for(var G=!1;void 0!==g[s]&&g[s]===f[s];)++s;if(G=void 0===g[s],this.debug){var H=Math.floor(g[s]/f[s]*100);H%20===0&&console.log("INFO: Geometry "+s+" at "+H+"% capacity.")}if(G){this.debug&&console.log("INFO: Geometry addition: "+s+(s%10===1?"st":s%10===2?"nd":s%10===3?"rd":"th")+" geometry."),n=new THREE.BufferGeometry,c[s]=n,d[s]=this.createMaterial("textured-phong",12092939),g[s]=1,i.set(s,new Map);var I=2*E,J=Math.floor(1.5*I);f[s]=J/2,o=new Float32Array(3*J*3),q=new Float32Array(3*J*3),p=new Float32Array(3*J*3),r=new Float32Array(3*J*2),this.debug&&console.log("New capacity will be "+3*J*3+".")}else n=c[s],g[s]+=1,o=n.attributes.position.array,p=n.attributes.color.array,q=n.attributes.normal.array,r=n.attributes.uv.array;var K=new THREE.Vector3,L=new THREE.Vector3,M=new THREE.Vector3,N=new THREE.Vector3,O=new THREE.Vector3,P=800,Q=new THREE.Color,R=g[s]-1,S=b[F],T=S>0;h.set(F,[s,R]),i.get(s).set(R,F),this.addFace(t,18*R,u,v,w,o,q,p,r,Math.abs(S),z,B,D,K,L,M,N,O,T,Q,P),G&&(n.addAttribute("position",new THREE.BufferAttribute(o,3)),n.addAttribute("normal",new THREE.BufferAttribute(q,3)),n.addAttribute("color",new THREE.BufferAttribute(p,3)),n.addAttribute("uv",new THREE.BufferAttribute(r,2)),e[s]=new THREE.Mesh(n,d[s]),this.addToScene(e[s],a)),n.attributes.position.needsUpdate=!0,n.attributes.color.needsUpdate=!0,n.attributes.normal.needsUpdate=!0,n.attributes.uv.needsUpdate=!0,n.computeBoundingSphere()}},updateChunkFaces:function(a,b,c){for(var d in b);}}),extend(App.Engine.Graphics.prototype,{createChunk:function(a,b,c,d,e){var f,g,h=b[0],i=b[1];for(var j in h){f=h[j],g=i[j];break}if(!f)return void console.log("Warn: missed an update");var k=a.split(","),l=parseInt(k[0]),m=l*c,n=parseInt(k[1]),o=n*d,p=parseInt(k[2]),q=p*e,r=c,s=c*d,t=s*e,u=2*f.length,v=Math.floor(1.5*u);v+=v%2,this.debug&&console.log("On chunk "+a+", init geometry will be "+3*v*3+"-capable.");for(var w=new Float32Array(3*v*3),x=new Float32Array(3*v*3),y=new Float32Array(3*v*3),z=new Float32Array(3*v*2),A=new THREE.Vector3,B=new THREE.Vector3,C=new THREE.Vector3,D=new THREE.Vector3,E=new THREE.Vector3,F=new THREE.Color,G=new Map,H=new Map,I=0,J=0;J<f.length;++J){
var K=Math.abs(f[J]);G.set(K,[0,J]);var L=H.get(0);void 0===L&&(L=new Map,H.set(0,L)),L.set(J,K);var M=g[J]>0;this.addFace(K,I,r,s,t,w,x,y,z,Math.abs(g[J]),m,o,q,A,B,C,D,E,M,F),I+=18}var N=new THREE.BufferGeometry;N.addAttribute("position",new THREE.BufferAttribute(w,3)),N.addAttribute("normal",new THREE.BufferAttribute(x,3)),N.addAttribute("color",new THREE.BufferAttribute(y,3)),N.addAttribute("uv",new THREE.BufferAttribute(z,2)),N.computeBoundingSphere();var O=this.createMaterial("textured-phong",11184810);return{geometries:[N],materials:[O],meshes:[new THREE.Mesh(N,O)],capacities:[v/2],sizes:[u/2],whereToFindFace:G,whichFaceIs:H}},updateChunk:function(a,b,c,d,e,f,g){var h=b.geometries,i=b.materials,j=b.meshes,k=b.capacities,l=b.sizes,m=b.whereToFindFace,n=b.whichFaceIs,o=d[0],p=d[1],q=d[2];this.removeChunkFaces(a,o,h,i,j,k,l,m,n),this.addChunkFaces(a,p,h,i,j,k,l,m,n,c,e,f,g),this.updateChunkFaces(a,q,h)},removeChunkFaces:function(a,b,c,d,e,f,g,h,i){var j,k,l,m,n,o;for(var p in b)if(p=parseInt(p),h.has(p)){var q=h.get(p);o=q[0];var r=q[1];j=c[o],k=j.attributes.position.array,l=j.attributes.color.array,m=j.attributes.normal.array,n=j.attributes.uv.array;var s,t,u=g[o]-1,v=u===r;if(v){for(s=0;18>s;++s)t=18*r+s,k[t]=m[t]=l[t]=0;for(s=0;12>s;++s)n[12*r+s]=0}else{for(s=0;18>s;++s){t=18*r+s;var w=18*u+s;k[t]=k[w],m[t]=m[w],l[t]=l[w],k[w]=m[w]=l[w]=0}for(s=0;12>s;++s){t=12*r+s;var x=12*u+s;n[t]=n[x],n[x]=0}}if(!v){var y=i.get(o);void 0===y.get(u)&&(console.log("WARN: swapping"),console.log(i[o][u]+" @mesh "+o+" @lastposition "+u+" @position "+r)),h.set(y.get(u),[o,r]),y.set(r,y.get(u))}i.get(o)["delete"](u),h["delete"](p),g[o]-=1,0===g[o]?(console.log("INFO: geometry deletion."),this.sceneManager.removeFromScene(e[o],a),c[o]=void 0,d[o]=void 0,e[o]=void 0,g[o]=void 0,f[o]=void 0,i["delete"](o)):(j.attributes.position.needsUpdate=!0,j.attributes.color.needsUpdate=!0,j.attributes.normal.needsUpdate=!0,j.attributes.uv.needsUpdate=!0,j.computeBoundingSphere())}else console.log("Trying to remove a face that is not present in chunk: "+p)},addChunkFaces:function(a,b,c,d,e,f,g,h,i,j,k,l,m){var n,o,p,q,r,s,t,u=k,v=k*l,w=v*m,x=j.split(","),y=parseInt(x[0]),z=y*k,A=parseInt(x[1]),B=A*l,C=parseInt(x[2]),D=C*m,E=this.defaultGeometrySize;for(var F in b)if(F=parseInt(F),t=Math.abs(F),h.hasOwnProperty(t))console.log("Trying to add a face that is already present in chunk.");else{s=0;for(var G=!1;void 0!==g[s]&&g[s]===f[s];)++s;if(G=void 0===g[s],this.debug){var H=Math.floor(g[s]/f[s]*100);H%20===0&&console.log("INFO: Geometry "+s+" at "+H+"% capacity.")}if(G){this.debug&&console.log("INFO: Geometry addition: "+s+(s%10===1?"st":s%10===2?"nd":s%10===3?"rd":"th")+" geometry."),n=new THREE.BufferGeometry,c[s]=n,d[s]=this.createMaterial("textured-phong",12092939),g[s]=1,i.set(s,new Map);var I=2*E,J=Math.floor(1.5*I);f[s]=J/2,o=new Float32Array(3*J*3),q=new Float32Array(3*J*3),p=new Float32Array(3*J*3),r=new Float32Array(3*J*2),this.debug&&console.log("New capacity will be "+3*J*3+".")}else n=c[s],g[s]+=1,o=n.attributes.position.array,p=n.attributes.color.array,q=n.attributes.normal.array,r=n.attributes.uv.array;var K=new THREE.Vector3,L=new THREE.Vector3,M=new THREE.Vector3,N=new THREE.Vector3,O=new THREE.Vector3,P=800,Q=new THREE.Color,R=g[s]-1,S=b[F],T=S>0;h.set(F,[s,R]),i.get(s).set(R,F),this.addFace(t,18*R,u,v,w,o,q,p,r,Math.abs(S),z,B,D,K,L,M,N,O,T,Q,P),G&&(n.addAttribute("position",new THREE.BufferAttribute(o,3)),n.addAttribute("normal",new THREE.BufferAttribute(q,3)),n.addAttribute("color",new THREE.BufferAttribute(p,3)),n.addAttribute("uv",new THREE.BufferAttribute(r,2)),e[s]=new THREE.Mesh(n,d[s]),this.addToScene(e[s],a)),n.attributes.position.needsUpdate=!0,n.attributes.color.needsUpdate=!0,n.attributes.normal.needsUpdate=!0,n.attributes.uv.needsUpdate=!0,n.computeBoundingSphere()}},updateChunkFaces:function(a,b,c){for(var d in b);}}),extend(App.Engine.Graphics.prototype,{setColor:function(a,b,c,d){},getTexture:function(a){return this.textureCoordinates[a]},addFace:function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t){var u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J,K,L,M,N,O,P=2*b/3,Q=8,R=.00390625/Q,S=this.getTexture(j);if(e>a){for(H=a%c,I=(a-H)%d/c,J=Math.floor(a/d),v=k+1+H,z=l+I,D=m+J,w=v,A=z,E=D+1,x=v,B=z+1,F=D+1,y=v,C=z+1,G=D,f[b]=v,f[b+1]=z,f[b+2]=D,f[b+3]=s?w:x,f[b+4]=s?A:B,f[b+5]=s?E:F,f[b+6]=s?x:w,f[b+7]=s?B:A,f[b+8]=s?F:E,n.set(v,z,D),s?o.set(w,A,E):o.set(x,B,F),s?p.set(x,B,F):p.set(w,A,E),q.subVectors(p,o),r.subVectors(n,o),q.cross(r),q.normalize(),K=q.x,L=q.y,M=q.z,u=0;3>u;++u)g[b+3*u]=K,g[b+3*u+1]=L,g[b+3*u+2]=M;for(this.setColor(k,l,m,t),u=0;3>u;++u)h[b+3*u]=t.r,h[b+3*u+1]=t.g,h[b+3*u+2]=t.b;for(N=.0625*(s?S[0][0]:S[3][0]),O=.0625*(s?S[0][1]:S[3][1]),i[P]=N+0+R,i[P+1]=O+0+R,i[P+2]=N+(s?0+R:.0625-R),i[P+3]=O+.0625-R,i[P+4]=N+(s?.0625-R:0+R),i[P+5]=O+.0625-R,f[b+9]=v,f[b+10]=z,f[b+11]=D,f[b+12]=s?x:y,f[b+13]=s?B:C,f[b+14]=s?F:G,f[b+15]=s?y:x,f[b+16]=s?C:B,f[b+17]=s?G:F,n.set(v,z,D),s?o.set(x,B,F):o.set(y,C,G),s?p.set(y,C,G):p.set(x,B,F),q.subVectors(p,o),r.subVectors(n,o),q.cross(r),q.normalize(),K=q.x,L=q.y,M=q.z,u=0;3>u;++u)g[b+9+3*u]=K,g[b+9+3*u+1]=L,g[b+9+3*u+2]=M;for(this.setColor(k,l,m,t),u=0;3>u;++u)h[b+9+3*u]=t.r,h[b+9+3*u+1]=t.g,h[b+9+3*u+2]=t.b;i[P+6]=N+0+R,i[P+7]=O+0+R,i[P+8]=N+.0625-R,i[P+9]=O+(s?.0625-R:0+R),i[P+10]=N+.0625-R,i[P+11]=O+(s?0+R:.0625-R)}else if(2*e>a){for(a-=e,H=a%c,I=(a-H)%d/c,J=Math.floor(a/d),v=k+H,z=l+1+I,D=m+J,w=v+1,A=z,E=D,x=v+1,B=z,F=D+1,y=v,C=z,G=D+1,f[b]=v,f[b+1]=z,f[b+2]=D,f[b+3]=s?w:x,f[b+4]=s?A:B,f[b+5]=s?E:F,f[b+6]=s?x:w,f[b+7]=s?B:A,f[b+8]=s?F:E,n.set(v,z,D),s?o.set(w,A,E):o.set(x,B,F),s?p.set(x,B,F):p.set(w,A,E),q.subVectors(p,o),r.subVectors(n,o),q.cross(r),q.normalize(),K=q.x,L=q.y,M=q.z,u=0;3>u;++u)g[b+3*u]=K,g[b+3*u+1]=L,g[b+3*u+2]=M;for(this.setColor(k,l,m,t),u=0;3>u;++u)h[b+3*u]=t.r,h[b+3*u+1]=t.g,h[b+3*u+2]=t.b;for(N=.0625*(s?S[1][0]:S[4][0]),O=.0625*(s?S[1][1]:S[4][1]),i[P]=N+(s?.0625-R:0+R),i[P+1]=O+(0+R),i[P+2]=N+(s?0+R:.0625-R),i[P+3]=O+(s?0+R:.0625-R),i[P+4]=N+(s?0+R:.0625-R),i[P+5]=O+(s?.0625-R:0+R),f[b+9]=v,f[b+10]=z,f[b+11]=D,f[b+12]=s?x:y,f[b+13]=s?B:C,f[b+14]=s?F:G,f[b+15]=s?y:x,f[b+16]=s?C:B,f[b+17]=s?G:F,n.set(v,z,D),s?o.set(x,B,F):o.set(y,C,G),s?p.set(y,C,G):p.set(x,B,F),q.subVectors(p,o),r.subVectors(n,o),q.cross(r),q.normalize(),K=q.x,L=q.y,M=q.z,u=0;3>u;++u)g[b+9+3*u]=K,g[b+9+3*u+1]=L,g[b+9+3*u+2]=M;for(this.setColor(k,l,m,t),u=0;3>u;++u)h[b+9+3*u]=t.r,h[b+9+3*u+1]=t.g,h[b+9+3*u+2]=t.b;i[P+6]=N+(s?.0625-R:0+R),i[P+7]=O+0+R,i[P+8]=N+0+R,i[P+9]=O+.0625-R,i[P+10]=N+.0625-R,i[P+11]=O+.0625-R}else{for(a-=2*e,H=a%c,I=(a-H)%d/c,J=Math.floor(a/d),v=k+H,z=l+I,D=m+1+J,w=v,A=z+1,E=D,x=v+1,B=z+1,F=D,y=v+1,C=z,G=D,f[b]=v,f[b+1]=z,f[b+2]=D,f[b+3]=s?w:x,f[b+4]=s?A:B,f[b+5]=s?E:F,f[b+6]=s?x:w,f[b+7]=s?B:A,f[b+8]=s?F:E,n.set(v,z,D),s?o.set(w,A,E):o.set(x,B,F),s?p.set(x,B,F):p.set(w,A,E),q.subVectors(p,o),r.subVectors(n,o),q.cross(r),q.normalize(),K=q.x,L=q.y,M=q.z,u=0;3>u;++u)g[b+3*u]=K,g[b+3*u+1]=L,g[b+3*u+2]=M;for(this.setColor(k,l,m,t),u=0;3>u;++u)h[b+3*u]=t.r,h[b+3*u+1]=t.g,h[b+3*u+2]=t.b;for(N=.0625*(s?S[2][0]:S[5][0]),O=.0625*(s?S[2][1]:S[5][1]),i[P]=N+0+R,i[P+1]=O+0+R,i[P+2]=N+(s?0+R:.0625-R),i[P+3]=O+.0625-R,i[P+4]=N+(s?.0625-R:0+R),i[P+5]=O+.0625-R,f[b+9]=v,f[b+10]=z,f[b+11]=D,f[b+12]=s?x:y,f[b+13]=s?B:C,f[b+14]=s?F:G,f[b+15]=s?y:x,f[b+16]=s?C:B,f[b+17]=s?G:F,n.set(v,z,D),s?o.set(x,B,F):o.set(y,C,G),s?p.set(y,C,G):p.set(x,B,F),q.subVectors(p,o),r.subVectors(n,o),q.cross(r),q.normalize(),K=q.x,L=q.y,M=q.z,u=0;3>u;++u)g[b+9+3*u]=K,g[b+9+3*u+1]=L,g[b+9+3*u+2]=M;for(this.setColor(k,l,m,t),u=0;3>u;++u)h[b+9+3*u]=t.r,h[b+9+3*u+1]=t.g,h[b+9+3*u+2]=t.b;i[P+6]=N+0+R,i[P+7]=O+0+R,i[P+8]=N+.0625-R,i[P+9]=O+(s?.0625-R:0+R),i[P+10]=N+.0625-R,i[P+11]=O+(s?0+R:.0625-R)}for(u=0;18>u;++u)if(isNaN(f[b+u]))return void console.log("Transferred miscalculation on "+b+"th component.	normal: "+s+"\n	faceId: "+a)}}),extend(App.Engine.Graphics.prototype,{setColor:function(a,b,c,d){},getTexture:function(a){return this.textureCoordinates[a]},addFace:function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t){var u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J,K,L,M,N,O,P=2*b/3,Q=8,R=.00390625/Q,S=this.getTexture(j);if(e>a){for(H=a%c,I=(a-H)%d/c,J=Math.floor(a/d),v=k+1+H,z=l+I,D=m+J,w=v,A=z,E=D+1,x=v,B=z+1,F=D+1,y=v,C=z+1,G=D,f[b]=v,f[b+1]=z,f[b+2]=D,f[b+3]=s?w:x,f[b+4]=s?A:B,f[b+5]=s?E:F,f[b+6]=s?x:w,f[b+7]=s?B:A,f[b+8]=s?F:E,n.set(v,z,D),s?o.set(w,A,E):o.set(x,B,F),s?p.set(x,B,F):p.set(w,A,E),q.subVectors(p,o),r.subVectors(n,o),q.cross(r),q.normalize(),K=q.x,L=q.y,M=q.z,u=0;3>u;++u)g[b+3*u]=K,g[b+3*u+1]=L,g[b+3*u+2]=M;for(this.setColor(k,l,m,t),u=0;3>u;++u)h[b+3*u]=t.r,h[b+3*u+1]=t.g,h[b+3*u+2]=t.b;for(N=.0625*(s?S[0][0]:S[3][0]),O=.0625*(s?S[0][1]:S[3][1]),i[P]=N+0+R,i[P+1]=O+0+R,i[P+2]=N+(s?0+R:.0625-R),i[P+3]=O+.0625-R,i[P+4]=N+(s?.0625-R:0+R),i[P+5]=O+.0625-R,f[b+9]=v,f[b+10]=z,f[b+11]=D,f[b+12]=s?x:y,f[b+13]=s?B:C,f[b+14]=s?F:G,f[b+15]=s?y:x,f[b+16]=s?C:B,f[b+17]=s?G:F,n.set(v,z,D),s?o.set(x,B,F):o.set(y,C,G),s?p.set(y,C,G):p.set(x,B,F),q.subVectors(p,o),r.subVectors(n,o),q.cross(r),q.normalize(),K=q.x,L=q.y,M=q.z,u=0;3>u;++u)g[b+9+3*u]=K,g[b+9+3*u+1]=L,g[b+9+3*u+2]=M;for(this.setColor(k,l,m,t),u=0;3>u;++u)h[b+9+3*u]=t.r,h[b+9+3*u+1]=t.g,h[b+9+3*u+2]=t.b;i[P+6]=N+0+R,i[P+7]=O+0+R,i[P+8]=N+.0625-R,i[P+9]=O+(s?.0625-R:0+R),i[P+10]=N+.0625-R,i[P+11]=O+(s?0+R:.0625-R)}else if(2*e>a){for(a-=e,H=a%c,I=(a-H)%d/c,J=Math.floor(a/d),v=k+H,z=l+1+I,D=m+J,w=v+1,A=z,E=D,x=v+1,B=z,F=D+1,y=v,C=z,G=D+1,f[b]=v,f[b+1]=z,f[b+2]=D,f[b+3]=s?w:x,f[b+4]=s?A:B,f[b+5]=s?E:F,f[b+6]=s?x:w,f[b+7]=s?B:A,f[b+8]=s?F:E,n.set(v,z,D),s?o.set(w,A,E):o.set(x,B,F),s?p.set(x,B,F):p.set(w,A,E),q.subVectors(p,o),r.subVectors(n,o),q.cross(r),q.normalize(),K=q.x,L=q.y,M=q.z,u=0;3>u;++u)g[b+3*u]=K,g[b+3*u+1]=L,g[b+3*u+2]=M;for(this.setColor(k,l,m,t),u=0;3>u;++u)h[b+3*u]=t.r,h[b+3*u+1]=t.g,h[b+3*u+2]=t.b;for(N=.0625*(s?S[1][0]:S[4][0]),O=.0625*(s?S[1][1]:S[4][1]),i[P]=N+(s?.0625-R:0+R),i[P+1]=O+(0+R),i[P+2]=N+(s?0+R:.0625-R),i[P+3]=O+(s?0+R:.0625-R),i[P+4]=N+(s?0+R:.0625-R),i[P+5]=O+(s?.0625-R:0+R),f[b+9]=v,f[b+10]=z,f[b+11]=D,f[b+12]=s?x:y,f[b+13]=s?B:C,f[b+14]=s?F:G,f[b+15]=s?y:x,f[b+16]=s?C:B,f[b+17]=s?G:F,n.set(v,z,D),s?o.set(x,B,F):o.set(y,C,G),s?p.set(y,C,G):p.set(x,B,F),q.subVectors(p,o),r.subVectors(n,o),q.cross(r),q.normalize(),K=q.x,L=q.y,M=q.z,u=0;3>u;++u)g[b+9+3*u]=K,g[b+9+3*u+1]=L,g[b+9+3*u+2]=M;for(this.setColor(k,l,m,t),u=0;3>u;++u)h[b+9+3*u]=t.r,h[b+9+3*u+1]=t.g,h[b+9+3*u+2]=t.b;i[P+6]=N+(s?.0625-R:0+R),i[P+7]=O+0+R,i[P+8]=N+0+R,i[P+9]=O+.0625-R,i[P+10]=N+.0625-R,i[P+11]=O+.0625-R}else{for(a-=2*e,H=a%c,I=(a-H)%d/c,J=Math.floor(a/d),v=k+H,z=l+I,D=m+1+J,w=v,A=z+1,E=D,x=v+1,B=z+1,F=D,y=v+1,C=z,G=D,f[b]=v,f[b+1]=z,f[b+2]=D,f[b+3]=s?w:x,f[b+4]=s?A:B,f[b+5]=s?E:F,f[b+6]=s?x:w,f[b+7]=s?B:A,f[b+8]=s?F:E,n.set(v,z,D),s?o.set(w,A,E):o.set(x,B,F),s?p.set(x,B,F):p.set(w,A,E),q.subVectors(p,o),r.subVectors(n,o),q.cross(r),q.normalize(),K=q.x,L=q.y,M=q.z,u=0;3>u;++u)g[b+3*u]=K,g[b+3*u+1]=L,g[b+3*u+2]=M;for(this.setColor(k,l,m,t),u=0;3>u;++u)h[b+3*u]=t.r,h[b+3*u+1]=t.g,h[b+3*u+2]=t.b;for(N=.0625*(s?S[2][0]:S[5][0]),O=.0625*(s?S[2][1]:S[5][1]),i[P]=N+0+R,i[P+1]=O+0+R,i[P+2]=N+(s?0+R:.0625-R),i[P+3]=O+.0625-R,i[P+4]=N+(s?.0625-R:0+R),i[P+5]=O+.0625-R,f[b+9]=v,f[b+10]=z,f[b+11]=D,f[b+12]=s?x:y,f[b+13]=s?B:C,f[b+14]=s?F:G,f[b+15]=s?y:x,f[b+16]=s?C:B,f[b+17]=s?G:F,n.set(v,z,D),s?o.set(x,B,F):o.set(y,C,G),s?p.set(y,C,G):p.set(x,B,F),q.subVectors(p,o),r.subVectors(n,o),q.cross(r),q.normalize(),K=q.x,L=q.y,M=q.z,u=0;3>u;++u)g[b+9+3*u]=K,g[b+9+3*u+1]=L,g[b+9+3*u+2]=M;for(this.setColor(k,l,m,t),u=0;3>u;++u)h[b+9+3*u]=t.r,h[b+9+3*u+1]=t.g,h[b+9+3*u+2]=t.b;i[P+6]=N+0+R,i[P+7]=O+0+R,i[P+8]=N+.0625-R,i[P+9]=O+(s?.0625-R:0+R),i[P+10]=N+.0625-R,i[P+11]=O+(s?0+R:.0625-R)}for(u=0;18>u;++u)if(isNaN(f[b+u]))return void console.log("Transferred miscalculation on "+b+"th component.	normal: "+s+"\n	faceId: "+a)}}),extend(App.Engine.Graphics.prototype,{loadTextures:function(){this.texture=this.loadTexture("3.png"),this.textureCoordinates=this.getTextureCoordinates("minecraft>1.5")},loadTexture:function(a){var b=new THREE.TextureLoader,c=b.load("app/assets/textures/"+a);return c.generateMipmaps=!1,c.magFilter=THREE.NearestFilter,c.minFilter=THREE.NearestFilter,c},getTextureCoordinates:function(a){var b;return b="minecraft>1.5"===a?{1:[[3,15],[3,15],[0,15],[3,15],[3,15],[2,15]],2:[[1,15],[1,15],[1,15],[1,15],[1,15],[1,15]],3:[[2,15],[2,15],[2,15],[2,15],[2,15],[2,15]],4:[[4,15],[4,15],[5,15],[4,15],[4,15],[5,15]],5:[[4,15],[4,15],[4,15],[4,15],[4,15],[4,15]],6:[[5,15],[5,15],[6,15],[5,15],[5,15],[6,15]],7:[[7,15],[7,15],[7,15],[7,15],[7,15],[7,15]],17:[[2,14],[2,14],[2,14],[2,14],[2,14],[2,14]],18:[[1,13],[1,13],[1,13],[1,13],[1,13],[1,13]]}:{1:[[0,1],[0,1],[0,2],[0,1],[0,1],[0,0]],2:[[5,0],[5,0],[5,0],[5,0],[5,0],[5,0]],3:[[6,0],[6,0],[6,0],[6,0],[6,0],[6,0]],4:[[4,1],[4,1],[4,2],[4,1],[4,1],[4,0]],5:[[7,0],[7,0],[7,0],[7,0],[7,0],[7,0]],6:[[10,0],[10,0],[10,0],[10,0],[10,0],[10,0]],7:[[3,0],[3,0],[3,0],[3,0],[3,0],[3,0]],8:[[14,0],[14,0],[14,0],[14,0],[14,0],[14,0]],17:[[1,0],[1,0],[1,0],[1,0],[1,0],[1,0]],18:[[1,10],[1,10],[1,10],[1,10],[1,10],[1,10]]}}}),extend(App.Engine.Graphics.prototype,{loadTextures:function(){this.texture=this.loadTexture("3.png"),this.textureCoordinates=this.getTextureCoordinates("minecraft>1.5")},loadTexture:function(a){var b=new THREE.TextureLoader,c=b.load("app/assets/textures/"+a);return c.generateMipmaps=!1,c.magFilter=THREE.NearestFilter,c.minFilter=THREE.NearestFilter,c},getTextureCoordinates:function(a){var b;return b="minecraft>1.5"===a?{1:[[3,15],[3,15],[0,15],[3,15],[3,15],[2,15]],2:[[1,15],[1,15],[1,15],[1,15],[1,15],[1,15]],3:[[2,15],[2,15],[2,15],[2,15],[2,15],[2,15]],4:[[4,15],[4,15],[5,15],[4,15],[4,15],[5,15]],5:[[4,15],[4,15],[4,15],[4,15],[4,15],[4,15]],6:[[5,15],[5,15],[6,15],[5,15],[5,15],[6,15]],7:[[7,15],[7,15],[7,15],[7,15],[7,15],[7,15]],17:[[2,14],[2,14],[2,14],[2,14],[2,14],[2,14]],18:[[1,13],[1,13],[1,13],[1,13],[1,13],[1,13]]}:{1:[[0,1],[0,1],[0,2],[0,1],[0,1],[0,0]],2:[[5,0],[5,0],[5,0],[5,0],[5,0],[5,0]],3:[[6,0],[6,0],[6,0],[6,0],[6,0],[6,0]],4:[[4,1],[4,1],[4,2],[4,1],[4,1],[4,0]],5:[[7,0],[7,0],[7,0],[7,0],[7,0],[7,0]],6:[[10,0],[10,0],[10,0],[10,0],[10,0],[10,0]],7:[[3,0],[3,0],[3,0],[3,0],[3,0],[3,0]],8:[[14,0],[14,0],[14,0],[14,0],[14,0],[14,0]],17:[[1,0],[1,0],[1,0],[1,0],[1,0],[1,0]],18:[[1,10],[1,10],[1,10],[1,10],[1,10],[1,10]]}}}),App.Engine.Settings=function(a){this.app=a,this.listeners=[]},extend(App.Engine.Settings.prototype,{run:function(){var a=this.app;this.controlsEngine=a.engine.controls,this.stateManager=a.state,this.graphicsSettings=a.engine.graphics.settings,this.controlsSettings=a.engine.controls.settings,this.audioSettings=a.engine.audio.settings,$("#announce").addClass("settings").append(this.getHomeHTML()).center().fadeIn(),this.listenHome(),$(document).keydown(function(a){a.keyCode&&a.keyCode===this.controlsEngine.keyControls.escape&&($(document).off("keydown"),this.unlistenHome(),this.stateManager.setState("ingame"))}.bind(this))},stop:function(){return new Promise(function(a){var b=$("#announce");b.fadeOut(200,function(){b.empty().removeClass("settings"),a()})})},unlisten:function(){this.listeners.forEach(function(a){var b=$("#"+a);b.off("click"),b.off("keydown")}),this.listeners=[]}}),App.Engine.Settings=function(a){this.app=a,this.listeners=[]},extend(App.Engine.Settings.prototype,{run:function(){var a=this.app;this.controlsEngine=a.engine.controls,this.stateManager=a.state,this.graphicsSettings=a.engine.graphics.settings,this.controlsSettings=a.engine.controls.settings,this.audioSettings=a.engine.audio.settings,$("#announce").addClass("settings").append(this.getHomeHTML()).center().fadeIn(),this.listenHome(),$(document).keydown(function(a){a.keyCode&&a.keyCode===this.controlsEngine.keyControls.escape&&($(document).off("keydown"),this.unlistenHome(),this.stateManager.setState("ingame"))}.bind(this))},stop:function(){return new Promise(function(a){var b=$("#announce");b.fadeOut(200,function(){b.empty().removeClass("settings"),a()})})},unlisten:function(){this.listeners.forEach(function(a){var b=$("#"+a);b.off("click"),b.off("keydown")}),this.listeners=[]}}),extend(App.Engine.Settings.prototype,{getAudioHTML:function(a){var b='<table class="table table-bordered" style="width:100%" class="noselect">';b+='<tr id="return"><td>Return</td></tr>';for(var c in a)b+="<tr><td>"+a[c]+"</td></tr>";return b+="</table>"},goAudio:function(){this.unlistenHome(),$("#announce").empty().append(this.getAudioHTML(this.audioSettings)),this.listenReturn()},listenAudio:function(){}}),extend(App.Engine.Settings.prototype,{getAudioHTML:function(a){var b='<table class="table table-bordered" style="width:100%" class="noselect">';b+='<tr id="return"><td>Return</td></tr>';for(var c in a)b+="<tr><td>"+a[c]+"</td></tr>";return b+="</table>"},goAudio:function(){this.unlistenHome(),$("#announce").empty().append(this.getAudioHTML(this.audioSettings)),this.listenReturn()},listenAudio:function(){}}),extend(App.Engine.Settings.prototype,{getControlsHTML:function(a){var b='<table class="table table-bordered" style="width:100%" class="noselect">';if(a.hasOwnProperty("language")){var c='<select id="language" class="form-control"><option value="default">Choose your layout:</option><option value="en">en</option><option value="fr">fr</option></select>';b+="<tr><td>Keyboard layout</td><td>"+c+"</td></tr>"}return b+='<tr id="return"><td colspan="2">Return</td></tr>',b+="</table>"},goControls:function(){this.unlistenHome(),$("#announce").empty().append(this.getControlsHTML(this.controlsSettings)),this.listenReturn(),this.listenControls()},listenControls:function(){var a=this.app.engine.controls,b=$("#language");b.change(function(){var c=b.find("option:selected").val();a.changeLayout(c,!0)})},unlistenControls:function(){$("#language").off("change")}}),extend(App.Engine.Settings.prototype,{getControlsHTML:function(a){var b='<table class="table table-bordered" style="width:100%" class="noselect">';if(a.hasOwnProperty("language")){var c='<select id="language" class="form-control"><option value="default">Choose your layout:</option><option value="en">en</option><option value="fr">fr</option></select>';b+="<tr><td>Keyboard layout</td><td>"+c+"</td></tr>"}return b+='<tr id="return"><td colspan="2">Return</td></tr>',b+="</table>"},goControls:function(){this.unlistenHome(),$("#announce").empty().append(this.getControlsHTML(this.controlsSettings)),this.listenReturn(),this.listenControls()},listenControls:function(){var a=this.app.engine.controls,b=$("#language");b.change(function(){var c=b.find("option:selected").val();a.changeLayout(c,!0)})},unlistenControls:function(){$("#language").off("change")}}),extend(App.Engine.Settings.prototype,{getGraphicsHTML:function(a){var b='<table class="table table-bordered" style="width:100%" class="noselect">';for(var c in a)b+="<tr><td>"+a[c]+"</td></tr>";return b+='<tr id="return"><td>Return</td></tr>',b+="</table>"},goGraphics:function(){this.unlistenHome(),$("#announce").empty().append(this.getGraphicsHTML(this.graphicsSettings)),this.listenReturn()},listenGraphics:function(){}}),extend(App.Engine.Settings.prototype,{getGraphicsHTML:function(a){var b='<table class="table table-bordered" style="width:100%" class="noselect">';for(var c in a)b+="<tr><td>"+a[c]+"</td></tr>";return b+='<tr id="return"><td>Return</td></tr>',b+="</table>"},goGraphics:function(){this.unlistenHome(),$("#announce").empty().append(this.getGraphicsHTML(this.graphicsSettings)),this.listenReturn()},listenGraphics:function(){}}),extend(App.Engine.Settings.prototype,{getHomeHTML:function(){return'<table class="table table-bordered" style="width:100%" class="noselect"><tr id="graphics"><td>Graphics</td></tr><tr id="gameplay"><td>Gameplay</td></tr><tr id="audio"><td>Audio</td></tr><tr id="return"><td>Return</td></tr></table>'},goHome:function(){},listenHome:function(){$("#graphics").click(function(){this.goGraphics()}.bind(this)),$("#gameplay").click(function(){this.goControls()}.bind(this)),$("#audio").click(function(){this.goAudio()}.bind(this)),$("#return").click(function(){$(document).off("keydown"),this.unlistenHome(),this.stateManager.setState("ingame"),this.controlsEngine.requestPointerLock(),this.app.setFocused(!0)}.bind(this)),this.listeners.push("graphics","gameplay","audio","return")},unlistenHome:function(){$("#graphics").off("click"),$("#gameplay").off("click"),$("#audio").off("click")},listenReturn:function(){$("#return").click(function(){$("#return").off("click"),$("#announce").empty().append(this.getHomeHTML()),this.listenHome()}.bind(this))}}),extend(App.Engine.Settings.prototype,{getHomeHTML:function(){return'<table class="table table-bordered" style="width:100%" class="noselect"><tr id="graphics"><td>Graphics</td></tr><tr id="gameplay"><td>Gameplay</td></tr><tr id="audio"><td>Audio</td></tr><tr id="return"><td>Return</td></tr></table>'},goHome:function(){},listenHome:function(){$("#graphics").click(function(){this.goGraphics()}.bind(this)),$("#gameplay").click(function(){this.goControls()}.bind(this)),$("#audio").click(function(){this.goAudio()}.bind(this)),$("#return").click(function(){$(document).off("keydown"),this.unlistenHome(),this.stateManager.setState("ingame"),this.controlsEngine.requestPointerLock(),this.app.setFocused(!0)}.bind(this)),this.listeners.push("graphics","gameplay","audio","return")},unlistenHome:function(){$("#graphics").off("click"),$("#gameplay").off("click"),$("#audio").off("click")},listenReturn:function(){$("#return").click(function(){$("#return").off("click"),$("#announce").empty().append(this.getHomeHTML()),this.listenHome()}.bind(this))}}),App.Model.Client=function(a){this.app=a,this.selfComponent=new App.Model.Client.SelfComponent(this),this.eventComponent=new App.Model.Client.EventComponent(this)},extend(App.Model.Client.prototype,{init:function(){this.eventComponent.init()},refresh:function(){this.selfComponent.processChanges(),this.eventComponent.pushEvents()},triggerEvent:function(a,b){this.eventComponent.triggerEvent(a,b)},triggerChange:function(a,b){this.selfComponent.triggerChange(a,b)},getCameraInteraction:function(){return this.selfComponent.cameraInteraction}}),App.Model.Client=function(a){this.app=a,this.selfComponent=new App.Model.Client.SelfComponent(this),this.eventComponent=new App.Model.Client.EventComponent(this)},extend(App.Model.Client.prototype,{init:function(){this.eventComponent.init()},refresh:function(){this.selfComponent.processChanges(),this.eventComponent.pushEvents()},triggerEvent:function(a,b){this.eventComponent.triggerEvent(a,b)},triggerChange:function(a,b){this.selfComponent.triggerChange(a,b)},getCameraInteraction:function(){return this.selfComponent.cameraInteraction}}),App.Model.Client.EventComponent=function(a){this.clientModel=a,this.eventsToPush=[],this.activeControls={},this.numberOfEvents=0,this.maxNumberOfEventsPer16ms=16},extend(App.Model.Client.EventComponent.prototype,{init:function(){this.activeControls=this.getActiveControls()},triggerEvent:function(a,b){var c=this.clientModel.selfComponent,d=this.clientModel.app.model.server.selfModel;switch(a){case"m":this.triggerMovement(a,b);break;case"a":this.triggerAction(a,b);break;case"r":this.triggerRotation(a,b);break;case"ray":var e=c.clickInteraction;e.isBlock()?(b.push(d.getInventory().getItem(c.getCurrentItem())),this.triggerBlock("b",b)):e.isX()&&this.triggerBlock("x",b)}this.numberOfEvents++},pushEvents:function(){var a,b=this.clientModel.app.engine.connection,c=this.eventsToPush,d=this.maxNumberOfEventsPer16ms;this.numberOfEvents>d&&(this.filterEvents(),console.log("Calm down, user... "+this.numberOfEvents));for(var e=0,f=c.length;f>e;++e)a=c[e],b.send(a[0],a[1]);this.eventsToPush=[],this.numberOfEvents=0},getEventsOfType:function(a){for(var b=this.eventsToPush,c=[],d=0,e=b.length;e>d;++d){var f=b[d];f[0]===a&&c.push(f)}return c},filterEvents:function(){for(var a,b=this.eventsToPush,c=[],d=0,e=b.length;e>d;++d){var f=b[d];"r"!==f[0]?a=b[d]:c.push(f)}c.push(a),this.eventsToPush=c}}),App.Model.Client.EventComponent=function(a){this.clientModel=a,this.eventsToPush=[],this.activeControls={},this.numberOfEvents=0,this.maxNumberOfEventsPer16ms=16},extend(App.Model.Client.EventComponent.prototype,{init:function(){this.activeControls=this.getActiveControls()},triggerEvent:function(a,b){var c=this.clientModel.selfComponent,d=this.clientModel.app.model.server.selfModel;switch(a){case"m":this.triggerMovement(a,b);break;case"a":this.triggerAction(a,b);break;case"r":this.triggerRotation(a,b);break;case"ray":var e=c.clickInteraction;e.isBlock()?(b.push(d.getInventory().getItem(c.getCurrentItem())),this.triggerBlock("b",b)):e.isX()&&this.triggerBlock("x",b)}this.numberOfEvents++},pushEvents:function(){var a,b=this.clientModel.app.engine.connection,c=this.eventsToPush,d=this.maxNumberOfEventsPer16ms;this.numberOfEvents>d&&(this.filterEvents(),console.log("Calm down, user... "+this.numberOfEvents));for(var e=0,f=c.length;f>e;++e)a=c[e],b.send(a[0],a[1]);this.eventsToPush=[],this.numberOfEvents=0},getEventsOfType:function(a){for(var b=this.eventsToPush,c=[],d=0,e=b.length;e>d;++d){var f=b[d];f[0]===a&&c.push(f)}return c},filterEvents:function(){for(var a,b=this.eventsToPush,c=[],d=0,e=b.length;e>d;++d){var f=b[d];"r"!==f[0]?a=b[d]:c.push(f)}c.push(a),this.eventsToPush=c}}),extend(App.Model.Client.EventComponent.prototype,{triggerMovement:function(a,b){var c=this.activeControls,d=this.eventsToPush,e=function(){d.push([a,b])},f=this.getEventsOfType(a);switch(f.length>0,b){case"f":c.forward||e(),c.forward=!0;break;case"r":c.right||e(),c.right=!0;break;case"l":c.left||e(),c.left=!0;break;case"b":c.backwards||e(),c.backwards=!0;break;case"d":c.down||e(),c.down=!0;break;case"u":c.up||e(),c.up=!0;break;case"fx":c.forward=!1,e();break;case"rx":c.right=!1,e();break;case"lx":c.left=!1,e();break;case"bx":c.backwards=!1,e();break;case"dx":c.down=!1,e();break;case"ux":c.up=!1,e();break;case"xx":c.forward=!1,c.backwards=!1,c.right=!1,c.left=!1,e();break;default:console.log("Unrecognized action, could not trigger.")}},triggerAction:function(a,b){var c=this.eventsToPush;switch(b){case"g":c.push([a,b]);break;default:console.log("Unrecognized action, could not trigger.")}},triggerRotation:function(a,b){var c=this.eventsToPush;c.push([a,b])},triggerBlock:function(a,b){var c=this.eventsToPush;c.push([a,b])}}),extend(App.Model.Client.EventComponent.prototype,{triggerMovement:function(a,b){var c=this.activeControls,d=this.eventsToPush,e=function(){d.push([a,b])},f=this.getEventsOfType(a);switch(f.length>0,b){case"f":c.forward||e(),c.forward=!0;break;case"r":c.right||e(),c.right=!0;break;case"l":c.left||e(),c.left=!0;break;case"b":c.backwards||e(),c.backwards=!0;break;case"d":c.down||e(),c.down=!0;break;case"u":c.up||e(),c.up=!0;break;case"fx":c.forward=!1,e();break;case"rx":c.right=!1,e();break;case"lx":c.left=!1,e();break;case"bx":c.backwards=!1,e();break;case"dx":c.down=!1,e();break;case"ux":c.up=!1,e();break;case"xx":c.forward=!1,c.backwards=!1,c.right=!1,c.left=!1,e();break;default:console.log("Unrecognized action, could not trigger.")}},triggerAction:function(a,b){var c=this.eventsToPush;switch(b){case"g":c.push([a,b]);break;default:console.log("Unrecognized action, could not trigger.")}},triggerRotation:function(a,b){var c=this.eventsToPush;c.push([a,b])},triggerBlock:function(a,b){var c=this.eventsToPush;c.push([a,b])}}),extend(App.Model.Client.EventComponent.prototype,{getActiveControls:function(){return{forward:!1,backwards:!1,right:!1,left:!1,up:!1,down:!1}}}),extend(App.Model.Client.EventComponent.prototype,{getActiveControls:function(){return{forward:!1,backwards:!1,right:!1,left:!1,up:!1,down:!1}}}),App.Model.Client.SelfComponent=function(a){this.clientModel=a,this._cameraInteraction="first-person",this.cameraInteraction={isFirstPerson:function(){return"first-person"===this._cameraInteraction}.bind(this),isThirdPerson:function(){return"third-person"===this._cameraInteraction}.bind(this)},this._clickInteraction="block",this.clickInteraction={isBlock:function(){return"block"===this._clickInteraction}.bind(this),isX:function(){return"x"===this._clickInteraction}.bind(this)},this.currentItem=0,this.changes=[]},extend(App.Model.Client.SelfComponent.prototype,{getCurrentItem:function(){return this.currentItem},triggerChange:function(a,b){this.changes.push([a,b])},processChanges:function(){var a=this.changes;if(!(a.length<1)){var b=this,c=this.clientModel.app.model.server.selfModel,d=this.clientModel.app.engine.graphics;a.forEach(function(a){var e=a[0],f=a[1];if(e&&f)switch(e){case"camera":var g,h=c.avatar,i=c.worldId;g="toggle"===f?!c.displayAvatar:f,c.displayAvatar=g,g?b._cameraInteraction="third-person":b._cameraInteraction="first-person",d.changeAvatarVisibility(g,h,i),d.cameraManager.updateCameraPosition(c.position);break;case"interaction":"block"===b._clickInteraction?b._clickInteraction="x":"x"===b._clickInteraction&&(b._clickInteraction="block")}}),this.changes=[]}}}),App.Model.Client.SelfComponent=function(a){this.clientModel=a,this._cameraInteraction="first-person",this.cameraInteraction={isFirstPerson:function(){return"first-person"===this._cameraInteraction}.bind(this),isThirdPerson:function(){return"third-person"===this._cameraInteraction}.bind(this)},this._clickInteraction="block",this.clickInteraction={isBlock:function(){return"block"===this._clickInteraction}.bind(this),isX:function(){return"x"===this._clickInteraction}.bind(this)},this.currentItem=0,this.changes=[]},extend(App.Model.Client.SelfComponent.prototype,{getCurrentItem:function(){return this.currentItem},triggerChange:function(a,b){this.changes.push([a,b])},processChanges:function(){var a=this.changes;if(!(a.length<1)){var b=this,c=this.clientModel.app.model.server.selfModel,d=this.clientModel.app.engine.graphics;a.forEach(function(a){var e=a[0],f=a[1];if(e&&f)switch(e){case"camera":var g,h=c.avatar,i=c.worldId;g="toggle"===f?!c.displayAvatar:f,c.displayAvatar=g,g?b._cameraInteraction="third-person":b._cameraInteraction="first-person",d.changeAvatarVisibility(g,h,i),d.cameraManager.updateCameraPosition(c.position);break;case"interaction":"block"===b._clickInteraction?b._clickInteraction="x":"x"===b._clickInteraction&&(b._clickInteraction="block")}}),this.changes=[]}}}),App.Model.Hub=function(a){this.app=a,this.games=new Map},extend(App.Model.Hub.prototype,{update:function(a){console.log("Hub fetched."),a=JSON.parse(a);var b=this.app,c=this.games;for(var d in a){var e=a[d],f=c.get(d);if(f)for(var g=0;g<e.length;++g){var h=e[g];f.indexOf(h)<0&&f.push(h)}else c.set(d,e)}b.isLoading()?b.setState("hub",c):"hub"===b.getState()&&b.setState("hub",c)}}),App.Model.Hub=function(a){this.app=a,this.games=new Map},extend(App.Model.Hub.prototype,{update:function(a){console.log("Hub fetched."),a=JSON.parse(a);var b=this.app,c=this.games;for(var d in a){var e=a[d],f=c.get(d);if(f)for(var g=0;g<e.length;++g){var h=e[g];f.indexOf(h)<0&&f.push(h)}else c.set(d,e)}b.isLoading()?b.setState("hub",c):"hub"===b.getState()&&b.setState("hub",c)}}),App.Model.Server=function(a){this.app=a,this.selfModel=new App.Model.Server.SelfModel(a),this.chunkModel=new App.Model.Server.ChunkModel(a),this.entityModel=new App.Model.Server.EntityModel(a),this.xModel=new App.Model.Server.XModel(a,this.selfModel),this.isRunning=!1},extend(App.Model.Server.prototype,{init:function(){this.isRunning=!0,this.selfModel.init(),this.chunkModel.init(),this.entityModel.init(),this.xModel.init()},stop:function(){this.isRunning=!1},refresh:function(){this.selfModel.refresh(),this.chunkModel.refresh(),this.entityModel.refresh(),this.xModel.refresh()}}),App.Model.Server=function(a){this.app=a,this.selfModel=new App.Model.Server.SelfModel(a),this.chunkModel=new App.Model.Server.ChunkModel(a),this.entityModel=new App.Model.Server.EntityModel(a),this.xModel=new App.Model.Server.XModel(a,this.selfModel),this.isRunning=!1},extend(App.Model.Server.prototype,{init:function(){this.isRunning=!0,this.selfModel.init(),
this.chunkModel.init(),this.entityModel.init(),this.xModel.init()},stop:function(){this.isRunning=!1},refresh:function(){this.selfModel.refresh(),this.chunkModel.refresh(),this.entityModel.refresh(),this.xModel.refresh()}});var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(a){return typeof a}:function(a){return a&&"function"==typeof Symbol&&a.constructor===Symbol?"symbol":typeof a};App.Model.Server.ChunkModel=function(a){this.app=a,this.worlds=new Map,this.worldProperties=new Map,this.chunkUpdates=[];var b=a.engine.graphics;this.needsUpdate=!1,this.debug=!1,this.texture=b.loadTexture("atlas_512.png"),this.textureCoordinates=b.getTextureCoordinates()},extend(App.Model.Server.ChunkModel.prototype,{addWorld:function(a,b){if(!this.worlds.has(a)){console.log("This world I don't know... "+a);var c=new Map,d={chunkSizeX:b[0],chunkSizeY:b[1],chunkSizeZ:b[2]};return d.chunkCapacity=d.chunkSizeX*d.chunkSizeY*d.chunkSizeZ,this.worlds.set(a,c),this.worldProperties.set(a,d),d}},init:function(){},refresh:function(){if(this.needsUpdate){for(var a=this.app.engine.graphics,b=this.chunkUpdates,c=0,d=b.length;d>c;++c){var e=b[c];if("worlds"in e){var f=e.worlds;for(var g in f){for(var h=f[g],i=0,j=h.length;j>i;++i)h[i]=parseInt(h[i]);var k=this.addWorld(g,h);if(k){a.addScene(g);var l=a.createLight("hemisphere");l.position.set(.5,1,.75),a.addToScene(l,g)}}}for(var m in e)if("worlds"!==m){var n=e[m];for(var o in n){var p=n[o];if(p)if(this.isChunkLoaded(m,o)){if(3!=p.length)return console.log("WARN: corrupt update or model @refresh / updateChunk."),console.log(p),void(this.chunkUpdates=[]);this.updateChunk(m,o,p)}else{if(2!=p.length)return console.log("WARN: corrupt update or model @refresh / initChunk."),void console.log(p);this.initializeChunk(m,o,p)}else this.unloadChunk(m,o)}}}this.chunkUpdates=[],this.needsUpdate=!1}},updateChunks:function(a){if(a){if(this.debug){console.log(a);var b=0;for(var c in a)a[c][1][1]&&(b+=a[c][1][1].length);console.log(b)}this.chunkUpdates.push(a),this.needsUpdate=!0}},isChunkLoaded:function(a,b){var c=this.worlds.get(a);return c&&c.has(b)},initializeChunk:function(a,b,c){var d=this.app.engine.graphics,e=this.worlds.get(a);if(!e)return void console.log("Got chunk "+b+" ("+("undefined"==typeof a?"undefined":_typeof(a))+") from an unknown world: "+a);var f=this.worldProperties.get(a),g=f.chunkSizeX,h=f.chunkSizeY,i=f.chunkSizeZ,j=d.createChunk(b,c,g,h,i);if(e.set(b,j),!j||!j.hasOwnProperty("meshes"))return console.log("WARN. Update miss @ initializeChunk: "+b),void console.log(c);for(var k=j.meshes,l=0,m=k.length;m>l;++l)d.addToScene(k[l],a)},updateChunk:function(a,b,c){var d=this.app.engine.graphics,e=this.worlds.get(a);if(!e)return void console.log("Error: updateChunk trying to access unloaded world.");var f=this.worldProperties.get(a),g=e.get(b);if(!g)return void console.log("Error: updateChunk trying to update unloaded chunk.");var h=f.chunkSizeX,i=f.chunkSizeY,j=f.chunkSizeZ;d.updateChunk(a,g,b,c,h,i,j)},unloadChunk:function(a,b){var c=this.app.engine.graphics,d=this.worlds.get(a);if(d){var e=d.get(b);if(!e)return void console.log("WARN. Update miss @unloadChunk "+b);for(var f=e.meshes,g=0,h=f.length;h>g;++g)c.removeFromScene(f[g],a);d["delete"](b)}},getCloseTerrain:function(a){a||(a="-1");var b=this.worlds.get(a);if(b){var c=[];return b.forEach(function(a,d){return a&&a.hasOwnProperty("meshes")?void a.meshes.forEach(function(a){c.push(a)}):(console.log("Warn: corrupted chunk inside client model "+d),void console.log(b))}),c}}}),App.Model.Server.ChunkModel=function(a){this.app=a,this.worlds=new Map,this.worldProperties=new Map,this.chunkUpdates=[];var b=a.engine.graphics;this.needsUpdate=!1,this.debug=!1,this.texture=b.loadTexture("atlas_512.png"),this.textureCoordinates=b.getTextureCoordinates()},extend(App.Model.Server.ChunkModel.prototype,{addWorld:function(a,b){if(!this.worlds.has(a)){console.log("This world I don't know... "+a);var c=new Map,d={chunkSizeX:b[0],chunkSizeY:b[1],chunkSizeZ:b[2]};return d.chunkCapacity=d.chunkSizeX*d.chunkSizeY*d.chunkSizeZ,this.worlds.set(a,c),this.worldProperties.set(a,d),d}},init:function(){},refresh:function(){if(this.needsUpdate){for(var a=this.app.engine.graphics,b=this.chunkUpdates,c=0,d=b.length;d>c;++c){var e=b[c];if("worlds"in e){var f=e.worlds;for(var g in f){for(var h=f[g],i=0,j=h.length;j>i;++i)h[i]=parseInt(h[i]);var k=this.addWorld(g,h);if(k){a.addScene(g);var l=a.createLight("hemisphere");l.position.set(.5,1,.75),a.addToScene(l,g)}}}for(var m in e)if("worlds"!==m){var n=e[m];for(var o in n){var p=n[o];if(p)if(this.isChunkLoaded(m,o)){if(3!=p.length)return console.log("WARN: corrupt update or model @refresh / updateChunk."),console.log(p),void(this.chunkUpdates=[]);this.updateChunk(m,o,p)}else{if(2!=p.length)return console.log("WARN: corrupt update or model @refresh / initChunk."),void console.log(p);this.initializeChunk(m,o,p)}else this.unloadChunk(m,o)}}}this.chunkUpdates=[],this.needsUpdate=!1}},updateChunks:function(a){if(a){if(this.debug){console.log(a);var b=0;for(var c in a)a[c][1][1]&&(b+=a[c][1][1].length);console.log(b)}this.chunkUpdates.push(a),this.needsUpdate=!0}},isChunkLoaded:function(a,b){var c=this.worlds.get(a);return c&&c.has(b)},initializeChunk:function(a,b,c){var d=this.app.engine.graphics,e=this.worlds.get(a);if(!e)return void console.log("Got chunk "+b+" ("+typeof a+") from an unknown world: "+a);var f=this.worldProperties.get(a),g=f.chunkSizeX,h=f.chunkSizeY,i=f.chunkSizeZ,j=d.createChunk(b,c,g,h,i);if(e.set(b,j),!j||!j.hasOwnProperty("meshes"))return console.log("WARN. Update miss @ initializeChunk: "+b),void console.log(c);for(var k=j.meshes,l=0,m=k.length;m>l;++l)d.addToScene(k[l],a)},updateChunk:function(a,b,c){var d=this.app.engine.graphics,e=this.worlds.get(a);if(!e)return void console.log("Error: updateChunk trying to access unloaded world.");var f=this.worldProperties.get(a),g=e.get(b);if(!g)return void console.log("Error: updateChunk trying to update unloaded chunk.");var h=f.chunkSizeX,i=f.chunkSizeY,j=f.chunkSizeZ;d.updateChunk(a,g,b,c,h,i,j)},unloadChunk:function(a,b){var c=this.app.engine.graphics,d=this.worlds.get(a);if(d){var e=d.get(b);if(!e)return void console.log("WARN. Update miss @unloadChunk "+b);for(var f=e.meshes,g=0,h=f.length;h>g;++g)c.removeFromScene(f[g],a);d["delete"](b)}},getCloseTerrain:function(a){a||(a="-1");var b=this.worlds.get(a);if(b){var c=[];return b.forEach(function(a,d){return a&&a.hasOwnProperty("meshes")?void a.meshes.forEach(function(a){c.push(a)}):(console.log("Warn: corrupted chunk inside client model "+d),void console.log(b))}),c}}}),App.Model.Server.EntityModel=function(a){this.app=a,this.entitiesIngame=new Map,this.entitiesOutdated=new Map,this.entitiesLoading=new Set,this.needsUpdate=!1},extend(App.Model.Server.EntityModel.prototype,{init:function(){},addEntity:function(a,b,c,d){switch(this.entitiesLoading.add(a),b.k){case"player":this.loadPlayer(a,b,c,d);break;default:console.log("ServerModel::addEntity: Unknown entity type.")}},removeEntity:function(a,b,c){var d=c.get(a);b.removeFromScene(d),c["delete"](a)},updateEntity:function(a,b,c,d,e){var f=b.position,g=c.p,h=f.x!==g[0]||f.y!==g[1];f.x=g[0],f.y=g[1],f.z=g[2],b.rotation.y=Math.PI+c.r[0],h&&d.updateAnimation(a),e.set(a,b)},refresh:function(){if(this.needsUpdate){var a=this.app.engine.graphics,b=this.entitiesIngame,c=this.entitiesOutdated;c.forEach(function(c,d){if(!this.entitiesLoading.has(d)){var e=b.get(d);c?e?this.updateEntity(d,e,c,a,b):this.addEntity(d,c,a,b):this.removeEntity(d,a,b)}}.bind(this)),this.entitiesOutdated=new Map,this.needsUpdate=!1}},updateEntities:function(a){if(!a)return void console.log("Empty update @ server.sub.entities.js");var b=this.entitiesOutdated;for(var c in a)b.set(c,a[c]);this.needsUpdate=!0}}),App.Model.Server.EntityModel=function(a){this.app=a,this.entitiesIngame=new Map,this.entitiesOutdated=new Map,this.entitiesLoading=new Set,this.needsUpdate=!1},extend(App.Model.Server.EntityModel.prototype,{init:function(){},addEntity:function(a,b,c,d){switch(this.entitiesLoading.add(a),b.k){case"player":this.loadPlayer(a,b,c,d);break;default:console.log("ServerModel::addEntity: Unknown entity type.")}},removeEntity:function(a,b,c){var d=c.get(a);b.removeFromScene(d),c["delete"](a)},updateEntity:function(a,b,c,d,e){var f=b.position,g=c.p,h=f.x!==g[0]||f.y!==g[1];f.x=g[0],f.y=g[1],f.z=g[2],b.rotation.y=Math.PI+c.r[0],h&&d.updateAnimation(a),e.set(a,b)},refresh:function(){if(this.needsUpdate){var a=this.app.engine.graphics,b=this.entitiesIngame,c=this.entitiesOutdated;c.forEach(function(c,d){if(!this.entitiesLoading.has(d)){var e=b.get(d);c?e?this.updateEntity(d,e,c,a,b):this.addEntity(d,c,a,b):this.removeEntity(d,a,b)}}.bind(this)),this.entitiesOutdated=new Map,this.needsUpdate=!1}},updateEntities:function(a){if(!a)return void console.log("Empty update @ server.sub.entities.js");var b=this.entitiesOutdated;for(var c in a)b.set(c,a[c]);this.needsUpdate=!0}}),extend(App.Model.Server.EntityModel.prototype,{loadPlayer:function(a,b,c,d){c.initializeEntity(a,"steve",function(e){var f=c.finalizeEntity(a,e);c.addToScene(f,-1),this.updateEntity(a,f,b,c,d),this.entitiesLoading["delete"](a)}.bind(this))}}),extend(App.Model.Server.EntityModel.prototype,{loadPlayer:function(a,b,c,d){c.initializeEntity(a,"steve",function(e){var f=c.finalizeEntity(a,e);c.addToScene(f,-1),this.updateEntity(a,f,b,c,d),this.entitiesLoading["delete"](a)}.bind(this))}}),App.Model.Server.SelfModel=function(a){this.app=a,this.entityId="-1",this.worldId="-1",this.position=null,this.rotation=null,this.inventory=this.getInventory();a.engine.graphics;this.needsUpdate=!1,this.displayAvatar=!1,this.avatar=null},extend(App.Model.Server.SelfModel.prototype,{init:function(){var a=this.app.engine.graphics;this.loadSelf(a)},refresh:function(){if(this.needsUpdate){var a=this.app.register,b=this.position,c=this.rotation,d=this.entityId,e=this.app.engine.graphics,f=this.avatar;if(e.controls&&f){var g=f.position;if(null!==b&&null!==c&&null!==g){var h=g.x!==b[0]||g.y!==b[1];g.x=b[0],g.y=b[1],g.z=b[2],a.updateSelfState({position:[g.x,g.y,g.z]}),f.rotation.y=Math.PI+c[0],h&&e.updateAnimation(d),e.cameraManager.updateCameraPosition(b)}this.needsUpdate=!1}}},updateSelf:function(a,b){var c=this.position,d=this.rotation;c&&d&&c[0]===a[0]&&c[1]===a[1]&&c[2]===a[2]&&d[0]===b[0]&&d[1]===b[1]||(this.position=a,this.rotation=b,this.needsUpdate=!0)},loadSelf:function(a){var b=this.entityId,c=this.worldId;a.initializeEntity(b,"steve",function(d){var e=a.finalizeEntity(b,d);this.avatar=e,this.displayAvatar&&a.addToScene(e,c)}.bind(this))}}),App.Model.Server.SelfModel=function(a){this.app=a,this.entityId="-1",this.worldId="-1",this.position=null,this.rotation=null,this.inventory=this.getInventory();a.engine.graphics;this.needsUpdate=!1,this.displayAvatar=!1,this.avatar=null},extend(App.Model.Server.SelfModel.prototype,{init:function(){var a=this.app.engine.graphics;this.loadSelf(a)},refresh:function(){if(this.needsUpdate){var a=this.app.register,b=this.position,c=this.rotation,d=this.entityId,e=this.app.engine.graphics,f=this.avatar;if(e.controls&&f){var g=f.position;if(null!==b&&null!==c&&null!==g){var h=g.x!==b[0]||g.y!==b[1];g.x=b[0],g.y=b[1],g.z=b[2],a.updateSelfState({position:[g.x,g.y,g.z]}),f.rotation.y=Math.PI+c[0],h&&e.updateAnimation(d),e.cameraManager.updateCameraPosition(b)}this.needsUpdate=!1}}},updateSelf:function(a,b){var c=this.position,d=this.rotation;c&&d&&c[0]===a[0]&&c[1]===a[1]&&c[2]===a[2]&&d[0]===b[0]&&d[1]===b[1]||(this.position=a,this.rotation=b,this.needsUpdate=!0)},loadSelf:function(a){var b=this.entityId,c=this.worldId;a.initializeEntity(b,"steve",function(d){var e=a.finalizeEntity(b,d);this.avatar=e,this.displayAvatar&&a.addToScene(e,c)}.bind(this))}}),extend(App.Model.Server.SelfModel.prototype,{getInventory:function(){var a=new Uint8Array(256);return a[0]=1,{_items:a,getItem:function(a){return a!==parseInt(a,10)||0>a||a>256?-1:this._items[a]},setItem:function(a,b){a!==parseInt(a,10)||0>a||a>256||(this._items[a]=b)}}}}),extend(App.Model.Server.SelfModel.prototype,{getInventory:function(){var a=new Uint8Array(256);return a[0]=1,{_items:a,getItem:function(a){return a!==parseInt(a,10)||0>a||a>256?-1:this._items[a]},setItem:function(a,b){a!==parseInt(a,10)||0>a||a>256||(this._items[a]=b)}}}}),extend(App.Model.Server.prototype,{updateEntities:function(a){this.isRunning&&(a=JSON.parse(a),this.selfModel.updateSelf(a[0],a[1]),this.entityModel.updateEntities(a[2]))},updateChunks:function(a){this.isRunning&&(a=JSON.parse(a),this.chunkModel.updateChunks(a))},updateX:function(a){this.isRunning&&(a=JSON.parse(a),this.xModel.updateX(a))}}),extend(App.Model.Server.prototype,{updateEntities:function(a){this.isRunning&&(a=JSON.parse(a),this.selfModel.updateSelf(a[0],a[1]),this.entityModel.updateEntities(a[2]))},updateChunks:function(a){this.isRunning&&(a=JSON.parse(a),this.chunkModel.updateChunks(a))},updateX:function(a){this.isRunning&&(a=JSON.parse(a),this.xModel.updateX(a))}}),App.Model.Server.XModel=function(a,b){this.app=a,this.selfModel=b,this.portals=new Map,this.worldToPortals=new Map,this.backwardLinks=new Map,this.worldMap=new App.Model.Server.XModel.WorldMap(this),this.xUpdates=[],this.needsUpdate=!1},extend(App.Model.Server.XModel.prototype,{init:function(){},refresh:function(){if(this.needsUpdate){for(var a=this.app.register,b=this.worldMap,c=this.xUpdates,d=0,e=c.length;e>d;++d){var f=c[d];for(var g in f){var h=f[g],i=h instanceof Array;if(i&&h.length>0){var j=h[0],k=h[1],l=h[2],m=[h[3],h[4],h[5]],n=[h[6],h[7],h[8]],o=h[9],p=h[10];this.addPortal(g,j,k,l,m,n,o,p),b.invalidate(),a.updateSelfState({diagram:b.toString()})}else this.removePortal(g),b.invalidate(),a.updateSelfState({diagram:b.toString()})}}this.xUpdates=[],this.needsUpdate=!1}},updateX:function(a){this.xUpdates.push(a),this.needsUpdate=!0}}),App.Model.Server.XModel=function(a,b){this.app=a,this.selfModel=b,this.portals=new Map,this.worldToPortals=new Map,this.backwardLinks=new Map,this.worldMap=new App.Model.Server.XModel.WorldMap(this),this.xUpdates=[],this.needsUpdate=!1},extend(App.Model.Server.XModel.prototype,{init:function(){},refresh:function(){if(this.needsUpdate){for(var a=this.app.register,b=this.worldMap,c=this.xUpdates,d=0,e=c.length;e>d;++d){var f=c[d];for(var g in f){var h=f[g],i=h instanceof Array;if(i&&h.length>0){var j=h[0],k=h[1],l=h[2],m=[h[3],h[4],h[5]],n=[h[6],h[7],h[8]],o=h[9],p=h[10];this.addPortal(g,j,k,l,m,n,o,p),b.invalidate(),a.updateSelfState({diagram:b.toString()})}else this.removePortal(g),b.invalidate(),a.updateSelfState({diagram:b.toString()})}}this.xUpdates=[],this.needsUpdate=!1}},updateX:function(a){this.xUpdates.push(a),this.needsUpdate=!0}}),App.Model.Server.XModel.Portal=function(a,b,c,d,e,f,g,h){this.portalId=a,this.portalLinkedForward=b,this.chunkId=c,this.worldId=d;var i=e[0],j=(f[0],e[1]),k=(f[1],e[2]);f[2];this.tempPosition=[i,j,k],this.tempWidth=1,this.tempHeight=2},App.Model.Server.XModel.Portal=function(a,b,c,d,e,f,g,h){this.portalId=a,this.portalLinkedForward=b,this.chunkId=c,this.worldId=d;var i=e[0],j=(f[0],e[1]),k=(f[1],e[2]);f[2];this.tempPosition=[i,j,k],this.tempWidth=1,this.tempHeight=2};var XNode,XArc,XGraph;XNode=function(a,b){this.nodeId=a,b?this.parentArcs=[b]:this.parentArcs=[],this.childrenArcs=[]},extend(XNode.prototype,{getNodeId:function(){return this.nodeId},getNumberOfChildren:function(){return this.childrenArcs.length},addExistingChild:function(a,b){var c=new XArc(this,b,a);return b.parentArcs.push(c),this.childrenArcs.push(c),b},addNewChild:function(a,b){var c=new XNode(b),d=new XArc(this,c,a);return c.parentArcs.push(d),this.childrenArcs.push(d),c},getParentArcId:function(){if(null===this.parentArcs)throw"Root has no parent.";return this.parentArcs.getArcId()},getChildrenArcs:function(){return this.childrenArcs},forEachChild:function(a){this.childrenArcs.forEach(function(b){a(b)})}}),XArc=function(a,b,c){this.arcId=c,this.parentNode=a,this.childNode=b},extend(XArc.prototype,{getChild:function(){return this.childNode},getParent:function(){return this.parentNode},getArcId:function(){return this.arcId}}),XGraph=function(a){this.root=new XNode(a,null),this.nodes=new Map,this.nodes.set(a,this.root)},extend(XGraph.prototype,{insertNode:function(a,b,c){var d=this.nodes.get(c);d||(d=new XNode(c,null),this.nodes.set(c,d));var e=this.nodes.get(b);return e?d.addExistingChild(a,e):(e=d.addNewChild(a,b),this.nodes.set(b,e)),e},hasNode:function(a){return this.nodes.has(a)},getNode:function(a){return this.nodes.get(a)},toString:function(){for(var a,b,c,d,e,f="",g=new Set,h=[this.root],i=[null],j=0,k=[j],l=[null],m=new Map,n=!1;h.length>0;){if(a=h.pop(),j=k.pop(),c=l.pop(),e=i.pop(),b=a.getNodeId(),c){d=c.getArcId();var o="";if(n=g.has(b)){var p=m.get(b);p===j-2?o="cyan":j-2>p?o="red":p>=j-1&&(o="orange")}else o="lime";for(var q="",r=0;j>r;++r)r===j-1?(q+=k.indexOf(j)>-1?"":"",q+=""):q+=k.indexOf(r)>-1?"|":k.indexOf(r+1)>-1?"|":"";f.length>1&&(f+="\n");var s="";e&&(s+="w."+e.getNodeId()+"..."),f+=q+o+" "+s+"w.{"+b+"} p."+d}if(!n){m.set(b,j),g.add(b);for(var t=j+1,u=a.getChildrenArcs(),v=0,w=u.length;w>v;++v){var x=u[v];l.push(x),h.push(x.getChild()),k.push(t),i.push(x.getParent())}}}return f}});var XNode,XArc,XGraph;XNode=function(a,b){this.nodeId=a,b?this.parentArcs=[b]:this.parentArcs=[],this.childrenArcs=[]},extend(XNode.prototype,{getNodeId:function(){return this.nodeId},getNumberOfChildren:function(){return this.childrenArcs.length},addExistingChild:function(a,b){var c=new XArc(this,b,a);return b.parentArcs.push(c),this.childrenArcs.push(c),b},addNewChild:function(a,b){var c=new XNode(b),d=new XArc(this,c,a);return c.parentArcs.push(d),this.childrenArcs.push(d),c},getParentArcId:function(){if(null===this.parentArcs)throw"Root has no parent.";return this.parentArcs.getArcId()},getChildrenArcs:function(){return this.childrenArcs},forEachChild:function(a){this.childrenArcs.forEach(function(b){a(b)})}}),XArc=function(a,b,c){this.arcId=c,this.parentNode=a,this.childNode=b},extend(XArc.prototype,{getChild:function(){return this.childNode},getParent:function(){return this.parentNode},getArcId:function(){return this.arcId}}),XGraph=function(a){this.root=new XNode(a,null),this.nodes=new Map,this.nodes.set(a,this.root)},extend(XGraph.prototype,{insertNode:function(a,b,c){var d=this.nodes.get(c);d||(d=new XNode(c,null),this.nodes.set(c,d));var e=this.nodes.get(b);return e?d.addExistingChild(a,e):(e=d.addNewChild(a,b),this.nodes.set(b,e)),e},hasNode:function(a){return this.nodes.has(a)},getNode:function(a){return this.nodes.get(a)},toString:function(){for(var a,b,c,d,e,f="",g=new Set,h=[this.root],i=[null],j=0,k=[j],l=[null],m=new Map,n=!1;h.length>0;){if(a=h.pop(),j=k.pop(),c=l.pop(),e=i.pop(),b=a.getNodeId(),c){d=c.getArcId();var o="";if(n=g.has(b)){var p=m.get(b);p===j-2?o="cyan":j-2>p?o="red":p>=j-1&&(o="orange")}else o="lime";for(var q="",r=0;j>r;++r)r===j-1?(q+=k.indexOf(j)>-1?"":"",q+=""):q+=k.indexOf(r)>-1?"|":k.indexOf(r+1)>-1?"|":"";f.length>1&&(f+="\n");var s="";e&&(s+="w."+e.getNodeId()+"..."),f+=q+o+" "+s+"w.{"+b+"} p."+d}if(!n){m.set(b,j),g.add(b);for(var t=j+1,u=a.getChildrenArcs(),v=0,w=u.length;w>v;++v){var x=u[v];l.push(x),h.push(x.getChild()),k.push(t),i.push(x.getParent())}}}return f}}),extend(App.Model.Server.XModel.prototype,{addPortal:function(a,b,c,d,e,f,g,h){var i=this.app.engine.graphics;console.log("Adding portal "+a+" and linking to "+b),a=parseInt(a),this.portals.has(a)&&console.log("Portal "+a+" was here already...");var j=new App.Model.Server.XModel.Portal(a,b,c,d,e,f,g,h);this.portals.set(a,j);var k=this.worldToPortals.get(d);k?k.add(a):(k=new Set,k.add(a),this.worldToPortals.set(d,k));var l=this.backwardLinks,m=l.get(a);console.log(l),console.log(a+", "+m);var n=this.portals;m&&m.forEach(function(a){var b=n.get(a);i.completeStubPortalObject(b,j)});var o=b?this.portals.get(b):null;o?(this.addBackwardLinks(a,b),this.addBackwardLinks(b,a),i.addPortalObject(j,o)):b?(this.addBackwardLinks(b,a),i.addStubPortalObject(j,b)):console.log("Error building stub portal: could not get other end.")},addBackwardLinks:function(a,b){var c=this.backwardLinks,d=c.get(b);d?d.add(a):(d=new Set,d.add(b),c.set(a,d))},removePortal:function(a){var b=this.app.engine.graphics;console.log("Removing portal "+a);var c=this.portals.get(a);c||console.log("	... portal "+a+" not present in model.");var d=this.backwardLinks,e=d.get(a);if(e&&e.forEach(function(a){b.removePartOfPortalObject(a,c)}),d["delete"](a),c){var f=c.worldId,g=this.worldToPortals.get(f);g["delete"](a),g.size<1&&this.worldToPortals["delete"](f)}c&&b.removePortalObject(c),this.portals["delete"](a)}}),extend(App.Model.Server.XModel.prototype,{addPortal:function(a,b,c,d,e,f,g,h){var i=this.app.engine.graphics;console.log("Adding portal "+a+" and linking to "+b),a=parseInt(a),this.portals.has(a)&&console.log("Portal "+a+" was here already...");var j=new App.Model.Server.XModel.Portal(a,b,c,d,e,f,g,h);this.portals.set(a,j);var k=this.worldToPortals.get(d);k?k.add(a):(k=new Set,k.add(a),this.worldToPortals.set(d,k));var l=this.backwardLinks,m=l.get(a);console.log(l),console.log(a+", "+m);var n=this.portals;m&&m.forEach(function(a){var b=n.get(a);i.completeStubPortalObject(b,j)});var o=b?this.portals.get(b):null;o?(this.addBackwardLinks(a,b),this.addBackwardLinks(b,a),i.addPortalObject(j,o)):b?(this.addBackwardLinks(b,a),i.addStubPortalObject(j,b)):console.log("Error building stub portal: could not get other end.")},addBackwardLinks:function(a,b){var c=this.backwardLinks,d=c.get(b);d?d.add(a):(d=new Set,d.add(b),c.set(a,d))},removePortal:function(a){var b=this.app.engine.graphics;console.log("Removing portal "+a);var c=this.portals.get(a);c||console.log("	... portal "+a+" not present in model.");var d=this.backwardLinks,e=d.get(a);if(e&&e.forEach(function(a){b.removePartOfPortalObject(a,c)}),d["delete"](a),c){var f=c.worldId,g=this.worldToPortals.get(f);g["delete"](a),g.size<1&&this.worldToPortals["delete"](f)}c&&b.removePortalObject(c),this.portals["delete"](a)}}),App.Model.Server.XModel.WorldMap=function(a){this.xModel=a,this.xGraph=null,this.string="",this.needsUpdate=!0},extend(App.Model.Server.XModel.WorldMap.prototype,{computeWorldMap:function(){var a,b,c,d,e=this.xModel.portals,f=this.xModel.selfModel.worldId,g=new XGraph(parseInt(f));e.forEach(function(f,h){d=f.worldId,a=f.portalLinkedForward,a&&(b=e.get(a),b&&(c=b.worldId,g.insertNode(parseInt(h),parseInt(c),parseInt(d))))}),this.xGraph=g,this.needsUpdate=!1},invalidate:function(){this.needsUpdate=!0},renderString:function(){return this.computeWorldMap(),this.string=this.xGraph.toString(),this.needsUpdate=!1,this.string},toString:function(){return this.needsUpdate&&this.renderString(),this.string}}),App.Model.Server.XModel.WorldMap=function(a){this.xModel=a,this.xGraph=null,this.string="",this.needsUpdate=!0},extend(App.Model.Server.XModel.WorldMap.prototype,{computeWorldMap:function(){var a,b,c,d,e=this.xModel.portals,f=this.xModel.selfModel.worldId,g=new XGraph(parseInt(f));e.forEach(function(f,h){d=f.worldId,a=f.portalLinkedForward,a&&(b=e.get(a),b&&(c=b.worldId,g.insertNode(parseInt(h),parseInt(c),parseInt(d))))}),this.xGraph=g,this.needsUpdate=!1},invalidate:function(){this.needsUpdate=!0},renderString:function(){return this.computeWorldMap(),this.string=this.xGraph.toString(),this.needsUpdate=!1,this.string},toString:function(){return this.needsUpdate&&this.renderString(),this.string}}),App.Modules.Chat=function(a){this.register=a},extend(App.Modules.Chat.prototype,{updateChat:function(a){console.log(a)},sendMessage:function(a){this.register.sendMessage("chat",a)}}),App.Modules.Chat=function(a){this.register=a},extend(App.Modules.Chat.prototype,{updateChat:function(a){console.log(a)},sendMessage:function(a){this.register.sendMessage("chat",a)}}),App.Modules.Hud=function(a){this.register=a},extend(App.Modules.Hud.prototype,{updateSelfState:function(a){if(a.hasOwnProperty("position")){var b=Math.floor,c=a.position,d=b(c[0])+", "+b(c[1])+", "+b(c[2]);$("#position").text(d).css("color","orange")}else if(a.hasOwnProperty("diagram")){for(var e=a.diagram,f=e.split(/\r?\n/g),g=["lime","orange","red","cyan"],h=0,i=f.length;i>h;++h){var j="white";g.forEach(function(a){f[h].indexOf(a)>-1&&(j=a)}),f[h]=f[h].replace(j,""),f[h]=f[h].replace("{",'<span style="color:'+j+';">'),f[h]=f[h].replace("}","</span>")}f=f.join("<br />"),f='<p style="color:white;">'+f+"</p>",$("#diagram").html(f)}}}),App.Modules.Hud=function(a){this.register=a},extend(App.Modules.Hud.prototype,{updateSelfState:function(a){if(a.hasOwnProperty("position")){var b=Math.floor,c=a.position,d=b(c[0])+", "+b(c[1])+", "+b(c[2]);$("#position").text(d).css("color","orange")}else if(a.hasOwnProperty("diagram")){for(var e=a.diagram,f=e.split(/\r?\n/g),g=["lime","orange","red","cyan"],h=0,i=f.length;i>h;++h){var j="white";g.forEach(function(a){f[h].indexOf(a)>-1&&(j=a)}),f[h]=f[h].replace(j,""),f[h]=f[h].replace("{",'<span style="color:'+j+';">'),f[h]=f[h].replace("}","</span>")}f=f.join("<br />"),f='<p style="color:white;">'+f+"</p>",$("#diagram").html(f)}}}),jQuery.fn.center=function(){return this.css("position","absolute"),this.css("top",Math.max(0,($(window).height()-$(this).outerHeight())/2+$(window).scrollTop())+"px"),this.css("left",Math.max(0,($(window).width()-$(this).outerWidth())/2+$(window).scrollLeft())+"px"),this},$(window).resize(function(){$("#announce").center()}),jQuery.fn.center=function(){return this.css("position","absolute"),this.css("top",Math.max(0,($(window).height()-$(this).outerHeight())/2+$(window).scrollTop())+"px"),this.css("left",Math.max(0,($(window).width()-$(this).outerWidth())/2+$(window).scrollLeft())+"px"),this},$(window).resize(function(){$("#announce").center()});var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(a){return typeof a}:function(a){return a&&"function"==typeof Symbol&&a.constructor===Symbol?"symbol":typeof a};"undefined"==typeof Promise&&function(a){function b(){}function c(a,b){return function(){a.apply(b,arguments)}}function d(a){if("object"!==_typeof(this))throw new TypeError("Promises must be constructed via new");if("function"!=typeof a)throw new TypeError("not a function");this._state=0,this._handled=!1,this._value=void 0,this._deferreds=[],j(a,this)}function e(a,b){for(;3===a._state;)a=a._value;return 0===a._state?void a._deferreds.push(b):(a._handled=!0,void d._immediateFn(function(){var c=1===a._state?b.onFulfilled:b.onRejected;if(null===c)return void(1===a._state?f:g)(b.promise,a._value);var d;try{d=c(a._value)}catch(e){return void g(b.promise,e)}f(b.promise,d)}))}function f(a,b){try{if(b===a)throw new TypeError("A promise cannot be resolved with itself.");if(b&&("object"===("undefined"==typeof b?"undefined":_typeof(b))||"function"==typeof b)){var e=b.then;if(b instanceof d)return a._state=3,a._value=b,void h(a);if("function"==typeof e)return void j(c(e,b),a)}a._state=1,a._value=b,h(a)}catch(f){g(a,f)}}function g(a,b){a._state=2,a._value=b,h(a)}function h(a){2===a._state&&0===a._deferreds.length&&d._immediateFn(function(){a._handled||d._unhandledRejectionFn(a._value)});for(var b=0,c=a._deferreds.length;c>b;b++)e(a,a._deferreds[b]);a._deferreds=null}function i(a,b,c){this.onFulfilled="function"==typeof a?a:null,this.onRejected="function"==typeof b?b:null,this.promise=c}function j(a,b){var c=!1;try{a(function(a){c||(c=!0,f(b,a))},function(a){c||(c=!0,g(b,a))})}catch(d){if(c)return;c=!0,g(b,d)}}var k=setTimeout;d.prototype["catch"]=function(a){return this.then(null,a)},d.prototype.then=function(a,c){var d=new this.constructor(b);return e(this,new i(a,c,d)),d},d.all=function(a){var b=Array.prototype.slice.call(a);return new d(function(a,c){function d(f,g){try{if(g&&("object"===("undefined"==typeof g?"undefined":_typeof(g))||"function"==typeof g)){var h=g.then;if("function"==typeof h)return void h.call(g,function(a){d(f,a)},c)}b[f]=g,0===--e&&a(b)}catch(i){c(i)}}if(0===b.length)return a([]);for(var e=b.length,f=0;f<b.length;f++)d(f,b[f])})},d.resolve=function(a){return a&&"object"===("undefined"==typeof a?"undefined":_typeof(a))&&a.constructor===d?a:new d(function(b){b(a)})},d.reject=function(a){return new d(function(b,c){c(a)})},d.race=function(a){return new d(function(b,c){for(var d=0,e=a.length;e>d;d++)a[d].then(b,c)})},d._immediateFn="function"==typeof setImmediate&&function(a){setImmediate(a)}||function(a){k(a,0)},d._unhandledRejectionFn=function(a){"undefined"!=typeof console&&console&&console.warn("Possible Unhandled Promise Rejection:",a)},d._setImmediateFn=function(a){d._immediateFn=a},d._setUnhandledRejectionFn=function(a){d._unhandledRejectionFn=a},"undefined"!=typeof module&&module.exports?module.exports=d:a.Promise||(a.Promise=d)}(window),"undefined"==typeof Promise&&function(a){function b(){}function c(a,b){return function(){a.apply(b,arguments)}}function d(a){if("object"!=typeof this)throw new TypeError("Promises must be constructed via new");if("function"!=typeof a)throw new TypeError("not a function");this._state=0,this._handled=!1,this._value=void 0,this._deferreds=[],j(a,this)}function e(a,b){for(;3===a._state;)a=a._value;return 0===a._state?void a._deferreds.push(b):(a._handled=!0,void d._immediateFn(function(){var c=1===a._state?b.onFulfilled:b.onRejected;if(null===c)return void(1===a._state?f:g)(b.promise,a._value);var d;try{d=c(a._value)}catch(e){return void g(b.promise,e)}f(b.promise,d)}))}function f(a,b){try{if(b===a)throw new TypeError("A promise cannot be resolved with itself.");if(b&&("object"==typeof b||"function"==typeof b)){var e=b.then;if(b instanceof d)return a._state=3,a._value=b,void h(a);if("function"==typeof e)return void j(c(e,b),a)}a._state=1,a._value=b,h(a)}catch(f){g(a,f)}}function g(a,b){a._state=2,a._value=b,h(a)}function h(a){2===a._state&&0===a._deferreds.length&&d._immediateFn(function(){a._handled||d._unhandledRejectionFn(a._value)});for(var b=0,c=a._deferreds.length;c>b;b++)e(a,a._deferreds[b]);a._deferreds=null}function i(a,b,c){this.onFulfilled="function"==typeof a?a:null,this.onRejected="function"==typeof b?b:null,this.promise=c}function j(a,b){var c=!1;try{a(function(a){c||(c=!0,f(b,a))},function(a){c||(c=!0,g(b,a))})}catch(d){if(c)return;c=!0,g(b,d)}}var k=setTimeout;d.prototype["catch"]=function(a){return this.then(null,a)},d.prototype.then=function(a,c){var d=new this.constructor(b);return e(this,new i(a,c,d)),d},d.all=function(a){var b=Array.prototype.slice.call(a);return new d(function(a,c){function d(f,g){try{if(g&&("object"==typeof g||"function"==typeof g)){var h=g.then;if("function"==typeof h)return void h.call(g,function(a){d(f,a)},c)}b[f]=g,0===--e&&a(b)}catch(i){c(i)}}if(0===b.length)return a([]);for(var e=b.length,f=0;f<b.length;f++)d(f,b[f])})},d.resolve=function(a){return a&&"object"==typeof a&&a.constructor===d?a:new d(function(b){b(a)})},d.reject=function(a){return new d(function(b,c){c(a)})},d.race=function(a){return new d(function(b,c){for(var d=0,e=a.length;e>d;d++)a[d].then(b,c)})},d._immediateFn="function"==typeof setImmediate&&function(a){setImmediate(a)}||function(a){k(a,0)},d._unhandledRejectionFn=function(a){"undefined"!=typeof console&&console&&console.warn("Possible Unhandled Promise Rejection:",a)},d._setImmediateFn=function(a){d._immediateFn=a},d._setUnhandledRejectionFn=function(a){d._unhandledRejectionFn=a},"undefined"!=typeof module&&module.exports?module.exports=d:a.Promise||(a.Promise=d)}(window),function(){var a=["ms","moz","webkit","o"],b=0;if("performance"in window||(window.performance={}),Date.now||(Date.now=function(){return(new Date).getTime()}),!("now"in window.performance)){var c=Date.now();performance.timing&&performance.timing.navigationStart&&(c=performance.timing.navigationStart),window.performance.now=function(){return Date.now()-c}}for(var d=0;d<a.length&&!window.requestAnimationFrame;++d)window.requestAnimationFrame=window[a[d]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[a[d]+"CancelAnimationFrame"]||window[a[d]+"CancelRequestAnimationFrame"];
window.requestAnimationFrame||(window.requestAnimationFrame=function(a){var c=Date.now(),d=Math.max(0,16-(c-b)),e=window.setTimeout(function(){a(c+d)},d);return b=c+d,e}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(a){clearTimeout(a)})}(),function(){var a=["ms","moz","webkit","o"],b=0;if("performance"in window||(window.performance={}),Date.now||(Date.now=function(){return(new Date).getTime()}),!("now"in window.performance)){var c=Date.now();performance.timing&&performance.timing.navigationStart&&(c=performance.timing.navigationStart),window.performance.now=function(){return Date.now()-c}}for(var d=0;d<a.length&&!window.requestAnimationFrame;++d)window.requestAnimationFrame=window[a[d]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[a[d]+"CancelAnimationFrame"]||window[a[d]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(a){var c=Date.now(),d=Math.max(0,16-(c-b)),e=window.setTimeout(function(){a(c+d)},d);return b=c+d,e}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(a){clearTimeout(a)})}(),App.Modules.Register=function(a){this.modules={}},extend(App.Modules.Register.prototype,{registerDefaultModules:function(){this.registerModule("chat",new App.Modules.Chat(this)),this.registerModule("hud",new App.Modules.Hud(this))},registerModule:function(a,b){if(this.modules.hasOwnProperty(a))throw"Error: module already registered.";this.modules[a]=b},updateSelfState:function(a){this.modules.hud.updateSelfState(a)},updateChat:function(a){this.modules.chat.updateChat(a)},sendMessage:function(a){console.log("Sending message.")}}),App.Modules.Register=function(a){this.modules={}},extend(App.Modules.Register.prototype,{registerDefaultModules:function(){this.registerModule("chat",new App.Modules.Chat(this)),this.registerModule("hud",new App.Modules.Hud(this))},registerModule:function(a,b){if(this.modules.hasOwnProperty(a))throw"Error: module already registered.";this.modules[a]=b},updateSelfState:function(a){this.modules.hud.updateSelfState(a)},updateChat:function(a){this.modules.chat.updateChat(a)},sendMessage:function(a){console.log("Sending message.")}}),App.State.StateManager=function(a){this.app=a,this.states={},this.previousState="",this.state="",this.focus=!1,this.register.forEach(function(a){a(this)}.bind(this))},App.State.StateManager.prototype.register=[],extend(App.State.StateManager.prototype,{registerState:function(a,b,c){this.states.hasOwnProperty(a)||(this.states[a]={start:b.bind(this),end:c.bind(this)})},setState:function(a,b){return this.previousState=this.state,this.state=a,this.states.hasOwnProperty(this.state)?void(this.states.hasOwnProperty(this.previousState)?this.states[this.previousState].end().then(function(){this.states[this.state].start(b)}.bind(this)):this.states[this.state].start(b)):void console.log("The specified state does not exist.")}}),App.State.StateManager=function(a){this.app=a,this.states={},this.previousState="",this.state="",this.focus=!1,this.register.forEach(function(a){a(this)}.bind(this))},App.State.StateManager.prototype.register=[],extend(App.State.StateManager.prototype,{registerState:function(a,b,c){this.states.hasOwnProperty(a)||(this.states[a]={start:b.bind(this),end:c.bind(this)})},setState:function(a,b){return this.previousState=this.state,this.state=a,this.states.hasOwnProperty(this.state)?void(this.states.hasOwnProperty(this.previousState)?this.states[this.previousState].end().then(function(){this.states[this.state].start(b)}.bind(this)):this.states[this.state].start(b)):void console.log("The specified state does not exist.")}}),App.State.StateManager.prototype.register.push(function(a){a.registerState("hub",a.startHub,a.endHub)}),extend(App.State.StateManager.prototype,{startHub:function(a){var b=this.app,c="";c+='<table class="table table-bordered" style="width:100%" class="noselect">',a.forEach(function(a,b){for(var d=0;d<a.length;++d)c+="<tr><td>"+b+"</td><td>"+a[d]+"</td></tr>"}),c+="</table>",c+='<div><button class="btn btn-default game-creator" style="float:none">Request 3D game creation</button></div>';var d=$("#announce");d.empty().removeClass().addClass("hub").append(c).center().fadeIn(),$("tr").click(function(){var a=$(this).find("td:first").text(),c=$(this).find("td:last").text();return""===a||""===c?void console.log("Invalid data."):void b.join(a,c)}),$(".game-creator").click(function(){b.requestGameCreation("game3d")})},endHub:function(){return $("tr").off("click"),$(".game-creator").off("click"),new Promise(function(a){var b=$("#announce");b.fadeOut(200,function(){b.empty().removeClass("hub"),a()})})}}),App.State.StateManager.prototype.register.push(function(a){a.registerState("hub",a.startHub,a.endHub)}),extend(App.State.StateManager.prototype,{startHub:function(a){var b=this.app,c="";c+='<table class="table table-bordered" style="width:100%" class="noselect">',a.forEach(function(a,b){for(var d=0;d<a.length;++d)c+="<tr><td>"+b+"</td><td>"+a[d]+"</td></tr>"}),c+="</table>",c+='<div><button class="btn btn-default game-creator" style="float:none">Request 3D game creation</button></div>';var d=$("#announce");d.empty().removeClass().addClass("hub").append(c).center().fadeIn(),$("tr").click(function(){var a=$(this).find("td:first").text(),c=$(this).find("td:last").text();return""===a||""===c?void console.log("Invalid data."):void b.join(a,c)}),$(".game-creator").click(function(){b.requestGameCreation("game3d")})},endHub:function(){return $("tr").off("click"),$(".game-creator").off("click"),new Promise(function(a){var b=$("#announce");b.fadeOut(200,function(){b.empty().removeClass("hub"),a()})})}}),App.State.StateManager.prototype.register.push(function(a){a.registerState("ingame",a.startIngame,a.endIngame)}),extend(App.State.StateManager.prototype,{startIngame:function(){$("#announce").removeClass().empty().addClass("reticle-wrapper").append('<div class="reticle"></div>').center().show()},endIngame:function(){return this.app.engine.controls.stopListeners(),new Promise(function(a){$("#announce").empty().removeClass("reticle-wrapper"),a()})}}),App.State.StateManager.prototype.register.push(function(a){a.registerState("ingame",a.startIngame,a.endIngame)}),extend(App.State.StateManager.prototype,{startIngame:function(){$("#announce").removeClass().empty().addClass("reticle-wrapper").append('<div class="reticle"></div>').center().show()},endIngame:function(){return this.app.engine.controls.stopListeners(),new Promise(function(a){$("#announce").empty().removeClass("reticle-wrapper"),a()})}}),App.State.StateManager.prototype.register.push(function(a){a.registerState("loading",a.startLoading,a.endLoading)}),extend(App.State.StateManager.prototype,{startLoading:function(){$("#announce").append('<div style="" class="title noselect"><p>spix<br/>engineering version</p></div>').append('<div id="cube" class="sk-folding-cube"><div class="sk-cube1 sk-cube"></div><div class="sk-cube2 sk-cube"></div><div class="sk-cube4 sk-cube"></div><div class="sk-cube3 sk-cube"></div></div>').center()},endLoading:function(){return new Promise(function(a){var b=$("#announce");b.fadeOut(200,function(){b.empty().removeClass("sk-folding-cube"),a()})})}}),App.State.StateManager.prototype.register.push(function(a){a.registerState("loading",a.startLoading,a.endLoading)}),extend(App.State.StateManager.prototype,{startLoading:function(){$("#announce").append('<div style="" class="title noselect"><p>spix<br/>engineering version</p></div>').append('<div id="cube" class="sk-folding-cube"><div class="sk-cube1 sk-cube"></div><div class="sk-cube2 sk-cube"></div><div class="sk-cube4 sk-cube"></div><div class="sk-cube3 sk-cube"></div></div>').center()},endLoading:function(){return new Promise(function(a){var b=$("#announce");b.fadeOut(200,function(){b.empty().removeClass("sk-folding-cube"),a()})})}}),App.State.StateManager.prototype.register.push(function(a){a.registerState("settings",a.startSettings,a.endSettings)}),extend(App.State.StateManager.prototype,{startSettings:function(){this.app.engine.settings.run()},endSettings:function(){return this.app.engine.settings.stop()}}),App.State.StateManager.prototype.register.push(function(a){a.registerState("settings",a.startSettings,a.endSettings)}),extend(App.State.StateManager.prototype,{startSettings:function(){this.app.engine.settings.run()},endSettings:function(){return this.app.engine.settings.stop()}});